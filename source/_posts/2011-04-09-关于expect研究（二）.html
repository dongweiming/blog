---
layout: post
title: 关于expect研究（二）
categories:
- expect
- linux基础
tags:
- switch
- tcl
- 控制结构
published: true
comments: true
indexer: true
---
<p>本文主要介绍expect,也就是tcl语言的控制结构
1  if ...else 结构
首先展示一个脚本,这个叫本用来根据argv0的输入选择不同的expect语句SSH远程登录到相对应的服务器,并设置一些错误输出:
<pre class="sh_bash">dongwm@linux-3qd1:~&gt; cat bin/test
#!/usr/bin/expect
set timeout 10
set passwordops01 cpuqPFtkt{20
set passwordops02 O^v44qftahbN
set passwordops03 9uujz)UUf7yr
set file1 [lindex $argv 0]
if {$argc!=1} {
puts stderr "参数错误,请使用以下格式: $argv0 {想去的服务器简称,比如ops01} "
exit 1
}
if {$file1=="ops01"} {
spawn luit -encoding gbk ssh dongwm@59.194.82.XX -p 9924
expect 194.168.45.XX
send "su -\n"   //设置了不容许root组直接登录
expect "口令："
send "$passwordops01\n"
interact
} elseif {$file1=="ops02"} {
spawn luit -encoding gbk ssh dongwm@59.194.82.XX -p 9924
expect 194.168.45.XX
send "ssh ops@ops04\n"
expect "192.168.9.24"
send "su -\n"
expect "口令："
send "$passwordops02\n"
interact
} elseif {$file1=="ops03"} {
spawn luit -encoding gbk ssh dongwm@59.194.82.XX -p 9960
expect 194.168.45.XX
send "su -\n"
expect "口令："
send "$passwordops03\n"
interact
}  else {
send "参数错误,请输入以下名称:ops01 ops02 ops03\n"
}
注:这个脚本里面有SSH信任 有根据iptables转发</p>

<p>if ...else 没啥可说的^.^</pre>
2 switch结构
还是上面的判断,我这里留下2个表达语法:
<!--
@page { margin: 2cm }
P { margin-bottom: 0.21cm }
--><pre class="sh_bash">switch -glob -- $file1 {
ops01 {
spawn luit -encoding gbk ssh dongwm@59.194.82.XX -p 9924expect 194.168.45.XX
send "su -\n"   //设置了不容许root组直接登录
expect "口令："
send "$passwordops01\n"
interact
}
ops02 {
spawn luit -encoding gbk ssh dongwm@59.194.82.XX -p 9924
expect 194.168.45.XX
send "ssh ops@ops04\n"
expect "192.168.9.24"
send "su -\n"
expect "口令："
send "$passwordops02\n"
interact
} </pre>
<p style="margin-left: 0.64cm; text-indent: -0.64cm; margin-bottom: 0cm;"></p>
<p style="margin-left: 0.64cm; text-indent: -0.64cm; margin-bottom: 0cm;">3  while结构 (顺便break和continue)</p>
<p style="margin-left: 0.64cm; text-indent: -0.64cm; margin-bottom: 0cm;"><pre class="sh_bash">dongwm@linux-3qd1:~&gt; cat !$
cat bin/test
#!/usr/bin/expect
set test 0
while {$test&lt;10} {
set test [expr {$test + 1}]
if {$test &gt; 7} break
if "$test &lt; 3" continue
puts "test is $test"
}
本来此例去掉break和continue会输出1..9 因为break存在只能输出到7 ,因为continue存在,当test=1,2的时候 不符合要求,直接略过了</pre></p>
<p style="margin-left: 0.64cm; text-indent: -0.64cm; margin-bottom: 0cm;">4  catch</p>
<p style="margin-left: 0.64cm; text-indent: -0.64cm; margin-bottom: 0cm;">catch用于捕捉让脚本停止执行的错误的输出:</p>
<p style="margin-left: 0.64cm; text-indent: -0.64cm; margin-bottom: 0cm;"><pre class="sh_bash">dongwm@linux-3qd1:~&gt; cat !$
cat bin/test1
#!/usr/bin/expect
proc Error {} {
error "This is a error for test"
}
catch Error test
puts $test
dongwm@linux-3qd1:~&gt; !$
bin/test1
This is a error for test</pre></p>
&nbsp;
<div id="livemargins_control" style="position: absolute; display: none; z-index: 9999;"><img style="position: absolute; left: -77px; top: -5px;" src="chrome://livemargins/skin/monitor-background-horizontal.png" alt="" width="77" height="5" /> <img style="position: absolute; left: 0; top: -5px;" src="chrome://livemargins/skin/monitor-background-vertical.png" alt="" /> <img id="monitor-play-button" style="position: absolute; left: 1px; top: 0; opacity: 0.5; cursor: pointer;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5" src="chrome://livemargins/skin/monitor-play-button.png" alt="" /></div>
<div class="zemanta-pixie"><img class="zemanta-pixie-img" src="http://img.zemanta.com/pixy.gif?x-id=96a78524-c46f-816f-a821-e23986f21990" alt="" /></div></p>
