---
layout: post
title: 使用UCARP实现虚拟IP故障转换，链路冗余
categories:
- 负载均衡
tags:
- ucarp
published: true
comments: true
indexer: true
---
<p>UCARP是一个使用CARP协议的高可用软件。可以在2台服务器上上设置虚拟IP地址，并让他们实现自动热备。类似于vrrp和hsrp协议。</p>

<p>1 下载安装
wget http://download.pureftpd.org/pub/ucarp/ucarp-1.5.2.tar.gz
tar zxvf ucarp-1.5.2.tar.gz
cd ucarp-1.5.2
./configure &amp;&amp; make &amp;&amp; make install
注：rpm包安装及不同系统不同版本都会造成ucarp安装的路径及启动/关闭虚拟IP的脚本文件的地址不同，不一定是我以下演示的路径</p>

<p>2 实验：
我这里有2台服务器 192.168.9.104 ，192.168.9.115  虚拟的IP是192.168.120.120
启动104上面的进程 （可以加-B后台运行把日志输入syslog）
ucarp --interface=eth0 --srcip=192.168.9.104 --vhid=1 --pass=mypassword --addr=192.168.120.120 --upscript=/usr/share/doc/ucarp-1.5.2/vip-up.sh --downscript=/usr/share/doc/ucarp-1.5.2/vip-down.sh
注：上面启动命令的释义：设置网络接口eth0上的虚拟ip 为192.168.120.120虚拟ip地址标识为1,密码是mypassword,真实地址为192.168.9.104,
运行脚本/usr/share/doc/ucarp-1.5.2/vip-up.sh当主机成为主服务器的时候,运行脚本/usr/share/doc/ucarp-1.5.2/vip-down.sh当虚拟ip被禁用的时候.这2个启动关闭的脚本是安装包自带的。
日志输出：
[INFO] Local advertised ethernet address is [00:50:56:ae:00:0e]
[WARNING] Switching to state: BACKUP
[WARNING] Spawning [/usr/libexec/ucarp/vip-down eth0 192.168.120.120]
[WARNING] Switching to state: MASTER
[WARNING] Spawning [/usr/libexec/ucarp/vip-up eth0 192.168.120.120]
启动115上面的进程
ucarp --interface=eth0 --srcip=192.168.9.104 --vhid=1 --pass=mypassword
--addr=192.168.120.120 --upscript=/usr/share/doc/ucarp-1.5.2/vip-up.sh
--downscript=/usr/share/doc/ucarp-1.5.2/vip-down.sh
日志输出
[INFO] Local advertised ethernet address is [00:50:56:ae:00:01]
[WARNING] Switching to state: BACKUP
[WARNING] Spawning [/usr/share/doc/ucarp-1.5.2/vip-down.sh eth0 192.168.120.120]
这个时候 我们登录192.168.120.120：
dongwm@dongwm:~$ ssh root@192.168.120.120 -p9922
Last login: Thu Jul 14 11:55:38 2011 from 192.168.8.83
root@104 ~&gt;
好了 我们登录了192.168.9.104这个机器，但是ifconfig并不会出现192.168.120.120这个虚拟接口</p>

<p>现在down掉104的进程，观察115的日志：
[WARNING] Switching to state: MASTER
[WARNING] Spawning [/usr/share/doc/ucarp-1.5.2/vip-up.sh eth0 192.168.120.120]</p>

<p>115变成了master，这时候登录192.168.120.120
dongwm@dongwm:~$ ssh root@192.168.120.120 -p9922
Last login: Thu Jul 14 11:58:22 2011 from 192.168.8.83
root@115~&gt;
登录的虚拟IP实际上已经换成了115
在这个过程中 我一直开了一个终端去ping192.168.120.120：
dongwm@dongwm:~$ ping 192.168.120.120
PING 192.168.120.120 (192.168.120.120) 56(84) bytes of data.
64 bytes from 192.168.120.120: icmp_req=1 ttl=64 time=0.780 ms
64 bytes from 192.168.120.120: icmp_req=2 ttl=64 time=0.273 ms
64 bytes from 192.168.120.120: icmp_req=3 ttl=64 time=0.297 ms
64 bytes from 192.168.120.120: icmp_req=4 ttl=64 time=0.315 ms
64 bytes from 192.168.120.120: icmp_req=5 ttl=64 time=0.306 ms
64 bytes from 192.168.120.120: icmp_req=6 ttl=64 time=0.369 ms
64 bytes from 192.168.120.120: icmp_req=7 ttl=64 time=0.311 ms
64 bytes from 192.168.120.120: icmp_req=8 ttl=64 time=0.355 ms
64 bytes from 192.168.120.120: icmp_req=9 ttl=64 time=0.286 ms
64 bytes from 192.168.120.120: icmp_req=10 ttl=64 time=0.349 ms
64 bytes from 192.168.120.120: icmp_req=11 ttl=64 time=0.638 ms
64 bytes from 192.168.120.120: icmp_req=12 ttl=64 time=0.353 ms
64 bytes from 192.168.120.120: icmp_req=13 ttl=64 time=0.339 ms
64 bytes from 192.168.120.120: icmp_req=14 ttl=64 time=0.288 ms
64 bytes from 192.168.120.120: icmp_req=15 ttl=64 time=0.316 ms
64 bytes from 192.168.120.120: icmp_req=16 ttl=64 time=0.366 ms
64 bytes from 192.168.120.120: icmp_req=17 ttl=64 time=0.309 ms
64 bytes from 192.168.120.120: icmp_req=18 ttl=64 time=0.366 ms
可以看到虚拟IP的漂移未造成链路的长时间的链路断掉。</p>

<p>&nbsp;</p>
