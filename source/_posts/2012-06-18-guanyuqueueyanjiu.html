---
layout: post
title: 关于Queue研究
categories:
- python模块研究
tags:
- Queue
published: true
comments: true
indexer: true
---
<p>前言：Queue提供了一个线程安全的FIFO功能.一般常用于多线程编程, 它可以在生产者和消费者线程中安全的传递消息或者其他数据. 调用者会自动创建锁, 当使用Queue对象, 你可以根据需求创建多个线程. 一个Queue的大小(元素的个数)受可用内存的限制</p>

<p><pre class="sh_python">
from Queue import Queue
from threading import Thread
import time
import feedparser #检索feed的内容  需要安装
num_fetch_threads = 2
enclosure_queue = Queue()  #可以设定 maxsize = 10  
feed_urls = [ 'http://ax.itunes.apple.com/WebObjects/MZStoreServices.woa/ws/RSS/topsongs/limit=10/xml',] #一个rss订阅地址，你懂的
def downloadEnclosures(i, q): #子线程使用的函数</p>

<p>    while True:
        print '%s: Looking for the next enclosure' % i
        url = q.get() #阻塞, 直到队列有东西返回 可以设定超时 timeout
        print '%s: Downloading:' % i, url
        time.sleep(i + 2) #可以采用其他办法，比如下载 这里为了演示效果sleep了一下
        q.task_done() #在完成这项工作之后，使用 <code>queue.task_done()</code> 函数向任务已经完成的队列发送一个信号
for i in range(num_fetch_threads):
    worker = Thread(target=downloadEnclosures, args=(i, enclosure_queue,))
    worker.setDaemon(True)
    worker.start()
for url in feed_urls:
    response = feedparser.parse(url)  
    for entry in response['entries']:
        for enclosure in entry.get('enclosures', []):
            print 'Queuing:', enclosure['url']
            enclosure_queue.put(enclosure['url']) #往队列里面加入url
print '*** Main thread waiting'
enclosure_queue.join() #等到队列为空，再执行别的操作
print '*** Done'
</pre></p>

<p>执行结果：</p>

<p>0: Looking for the next enclosure
1: Looking for the next enclosure
Queuing: http://a4.mzstatic.com/us/r1000/065/Music/35/e5/c6/mzi.bupwcfkr.aac.p.m4a
Queuing: http://a2.mzstatic.com/us/r1000/074/Music/3c/1f/71/mzi.zsmvohyi.aac.p.m4a
0: Downloading: Queuing: http://a1.mzstatic.com/us/r1000/108/Music/da/c6/a1/mzi.awhjgoey.aac.p.m4a
http://a4.mzstatic.com/us/r1000/065/Music/35/e5/c6/mzi.bupwcfkr.aac.p.m4a
Queuing: http://a4.mzstatic.com/us/r1000/065/Music/e6/38/b5/mzm.lvqyybtv.aac.p.m4a
1: Downloading: http://a2.mzstatic.com/us/r1000/074/Music/3c/1f/71/mzi.zsmvohyi.aac.p.m4a
Queuing: http://a1.mzstatic.com/us/r1000/117/Music/05/3d/59/mzm.tbfwkjza.aac.p.m4a
Queuing: http://a1.mzstatic.com/us/r1000/087/Music/3a/1f/c5/mzi.idwdqaeq.aac.p.m4a
Queuing: http://a1.mzstatic.com/us/r1000/090/Music/89/9c/a4/mzm.jujzxcsz.aac.p.m4a
Queuing: http://a5.mzstatic.com/us/r1000/071/Music/60/31/bb/mzm.jdguvcvo.aac.p.m4a
Queuing: http://a2.mzstatic.com/us/r1000/000/Music/65/25/e6/mzi.pjhbiyza.aac.p.m4a
Queuing: http://a3.mzstatic.com/us/r30/Music/6e/0e/2a/mzm.vieuqpdk.aac.p.m4a
*** Main thread waiting
0: Looking for the next enclosure
0: Downloading: http://a1.mzstatic.com/us/r1000/108/Music/da/c6/a1/mzi.awhjgoey.aac.p.m4a
1: Looking for the next enclosure
1: Downloading: http://a4.mzstatic.com/us/r1000/065/Music/e6/38/b5/mzm.lvqyybtv.aac.p.m4a
0: Looking for the next enclosure
0: Downloading: http://a1.mzstatic.com/us/r1000/117/Music/05/3d/59/mzm.tbfwkjza.aac.p.m4a
1: Looking for the next enclosure
1: Downloading: http://a1.mzstatic.com/us/r1000/087/Music/3a/1f/c5/mzi.idwdqaeq.aac.p.m4a
0: Looking for the next enclosure
0: Downloading: http://a1.mzstatic.com/us/r1000/090/Music/89/9c/a4/mzm.jujzxcsz.aac.p.m4a
0: Looking for the next enclosure
0: Downloading: http://a5.mzstatic.com/us/r1000/071/Music/60/31/bb/mzm.jdguvcvo.aac.p.m4a
1: Looking for the next enclosure
1: Downloading: http://a2.mzstatic.com/us/r1000/000/Music/65/25/e6/mzi.pjhbiyza.aac.p.m4a
0: Looking for the next enclosure
0: Downloading: http://a3.mzstatic.com/us/r30/Music/6e/0e/2a/mzm.vieuqpdk.aac.p.m4a
0: Looking for the next enclosure
1: Looking for the next enclosure
*** Done</p>
