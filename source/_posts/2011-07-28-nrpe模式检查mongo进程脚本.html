---
layout: post
title: nrpe模式检查mongodb进程脚本
categories:
- nagios
- python
tags:
- nrpe，mongodb进程
published: true
comments: true
indexer: true
---
<p>前言：nagios检查状态无外乎三种方式：1 直接到客户端取状态 2 nrpe间接再客户端取状态 3 被动检查通过nsca向nagios主服务器传送状态。这里是nrpe模式检查状态，要点包括 1 再nagios配置文件添加services 2 在客户端的nrpe.cfg里面添加command</p>

<p>1 在nagios添加配置：</p>

<p>define service{
use                     major-service
hostgroup_name          MongoGroup
service_description     check_mongo_procs
check_command           check_nrpe!check_mongo_procs  //选择nrpe模式
servicegroups           memory
contact_groups          sys
_SRCTYPE                sys
}</p>

<p>2 客户端nrpe.cfg添加：</p>

<p>command[check_mongo_procs]=/usr/local/nagios/libexec/check_mongopro.py</p>

<p>并重启nrpe进程</p>

<p>3 客户端脚本</p>

<p>cat /usr/local/nagios/libexec/check_mongopro.py</p>

<p><pre class="sh_python">
#!/bin/env python
# coding=gbk
import os
import sys
from subprocess import Popen, PIPE</p>

<p>list =[]
cmd = 'chkconfig --list |grep "启用"|grep mongo'
for line in os.popen(cmd).readlines():
     pro = line.split(' ')[0] 
     p1=Popen(['ps', '-ef'], stdout=PIPE)
     p2 = Popen(['grep', '-v', 'grep'], stdin=p1.stdout, stdout=PIPE) 
     p3 = Popen(['grep', '/etc/%s.conf' % pro], stdin=p2.stdout, stdout=PIPE)
     p4 = Popen(['awk', '{print $3}'], stdin=p3.stdout, stdout=PIPE)
     flag2 = [int(i.strip()) for i in p4.communicate()[0].split('\n') if i]
     if 1 not in flag2:
         list.append(pro)
         flag =1
if flag==1:
    print 'CRITICAL %s is dead!' % ','.join(list)
    sys.exit(2)
else:
    print 'Mongo Pro is OK'
</pre></p>
