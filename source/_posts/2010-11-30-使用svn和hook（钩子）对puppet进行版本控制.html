---
layout: post
title: 使用svn和hook（钩子）对puppet进行版本控制
categories:
- puppet
tags:
- hook
- svn
- 版本控制
- 钩子
published: true
comments: true
indexer: true
---
<p>puppet默认没有使用版本控制。可以在puppet.conf文件中添加一下一行：
<code>config_version = /usr/local/bin/return_version</code>
其中“/usr/local/bin/return_version” 是我自定义的脚本：<!--more--></p>

<p>[ccine_perl height="100%" width="99%"]#!/bin/bash</p>

<p>date +%Y%m%d%H[/ccine_perl]</p>

<p>so 简单 ^.^</p>

<p>puppet的这个版本号是用于与client端通信的信息，可以使用tagmail或者puppet的report功能，在基于webUI的dashboard或者foreman方便查阅自动化情况，通过时间判断是一个不错的办法。</p>

<p>svn的版本控制主要是对puppet部署的配置文件的控制，对于传送文件，使用exec执行客户端命令等操作不能进行回滚操作，需要自定义回滚方法（svn只负责svn服务器本地版本库内的文件系统）</p>

<p>1 安装svn</p>

<p>我使用yum安装：</p>

<p>#yum  install subversion mod_dav_svn mod_auth_mysql –y</p>

<p>2 确认是否已安装一下安装包：</p>

<p>openssl-XXX</p>

<p>openssl-devel-XXX</p>

<p>mod_ssl-XXX</p>

<p>mod_auth_mysql-XXX</p>

<p>subversion-XXX</p>

<p>mod_dav_svn-XXX</p>

<p>3 确认模块：</p>

<p>在/etc/httpd/modules（根据你的apache安装目录）</p>

<p>mod_authz_svn.so</p>

<p>mod_dav_svn.so</p>

<p>mod_auth_mysql.so</p>

<p>4 建立并创建svn版本库</p>

<p>#mkdir –p /opt/svn/puppet</p>

<p>#svnadmin create /opt/svn/puppet</p>

<p>5 修改SVN配置文件</p>

<p>#vi /opt/svn/puppet/conf/svnserve.conf(操作权限文件指定)</p>

<p>[ccine_perl height="100%" width="99%"][general]</p>

<p>auth-access = write</p>

<p>password-db = passwd</p>

<p>authz-db = authz</p>

<p>realm = puppet[/ccine_perl]</p>

<p>#vi /opt/svn/puppet/conf/password（容许访问SVN的用户及密码）</p>

<p>[ccine_perl height="100%" width="99%"][users]</p>

<p>puppet = <a href="mailto:Ry0va@g4zPbn">testpassword</a>[/ccine_perl]</p>

<p>#vi /opt/svn/puppet/conf/authz(用户对某目录及自动目录的访问权限，下面表示admin组对svn所有目录都有读写权限)</p>

<p>[ccine_perl height="100%" width="99%"][groups]</p>

<p>admin = puppet</p>

<p>[/]</p>

<p>@admin = rw[/ccine_perl]</p>

<p>6 启动svn</p>

<p>#svnserve -d –r /opt/svn/</p>

<p>7向版本库提交资源，我设置的路径是puppet模块的主目录(原因见下面的说明，默认为/etc/puppet,我指定到了其他路径,puppet.conf中指定）</p>

<p>#svn import –m “test” /usr/share/svn/modules  <a>file:///opt/svn/puppet</a></p>

<p>8 svn还是需要系统学习的，这里只是一个开端，，为了让大家尽快懂得svn，下面介绍一些会用到的命令包括：</p>

<p>svn add * （将新修改的配置以及新添加的文件纳入版本控制，这是在修改量大的情况下，最简单快速的办法）</p>

<p>svn commit -m "一些更新信息" （将新修改的配置提交到版本库）</p>

<p>svn co file:///home/okooo/apps/svn/puppet tmp（将版本库的内容拷贝一个副本到这次操作的目录下的tmp目录-这个都可以定义，默认就是版本库的名字，本例中是puppet）</p>

<p>svn up （下载一份完整的版本库内容到操作的目录下）</p>

<p>svn cleanup （有些时候在别人修改时候文件被锁定等原因，运行这个命令可以解除锁定）</p>

<p>svn del manifests/node/java.pp（将版本库的某些内容删除，这里是删除java.pp，然后svn commit就会成功删除）</p>

<p>svn diff manifests/node/java.pp （将修改后的java.pp文件和版本库的同名文件对比不同的内容）</p>

<p>svn log （查看更新内容的日志，这个log显示出来的就是上面执行“svn commit -m” 后的内容）</p>

<p>....</p>

<p>因为我们不涉及开发维护，所以svn不需要太熟，但是还是建议掌握所有内容</p>

<p><strong>SVN的hooks</strong></p>

<p><strong> </strong></p>

<p>钩子的功能其实我也迷糊了很久，我的理解就是在版本库出现修改时被触发的自定义脚本，这样可以确定很多属性：比如Pre-Commit钩子的作用是代码提交前是否有写messages，是否有tab，是否有不允许上传的文件，是否有超过限制大小的文件等等，这样可以控制一些不合适的提交。</p>

<p>以下是一个Pre-Commit钩子，用于检查语法错误：</p>

<p>检查puppet的.pp配置文件是否有问题，也可以执行：</p>

<p>puppet －v  你的主要配置文件site.pp
[ccine_perl height="100%" width="99%"]<code>#!/bin/sh
# SVN pre-commit hook to check Puppet syntax for .pp files
# Modified from http://mail.madstop.com/pipermail/puppet-users/2007-March/002034.html
REPOS="$1"
TXN="$2"
tmpfile=`mktemp`
export HOME=/
SVNLOOK=/usr/bin/svnlook
$SVNLOOK changed -t "$TXN" "$REPOS" | awk '/^[^D].*\.pp$/ {print $2}' | while read line
do
    $SVNLOOK cat -t "$TXN" "$REPOS" "$line" &gt; $tmpfile
    if [ $? -ne 0 ]
    then
        echo "Warning: Failed to checkout $line" &gt;&amp;2
    fi
    puppet --color=false --confdir=/etc/puppet --vardir=/var/lib/puppet --parseonly --ignoreimport $tmpfile &gt;&amp;2
    if [ $? -ne 0 ]
    then
        echo "Puppet syntax error in $line." &gt;&amp;2
        exit 2
    fi
done
res=$?
rm -f $tmpfile
if [ $res -ne 0 ]
then
    exit $res
fi</code>[/ccine_perl]</p>
