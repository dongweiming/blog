---
layout: post
title: 关于weakref研究
categories:
- python模块研究
tags:
- weakref
published: true
comments: true
indexer: true
---
<p>前言：对一个对象的弱引用。相对于通常的引用来说，如果一个对象有一个常规的引用，它是不会被垃圾收集器销毁的，但是如果一个对象只剩下一个弱引用，那么它可能被垃圾收集器收回。weakref就是这样的垃圾收集对象的引用模块</p>

<p><pre class="sh_python">
import weakref</p>

<p>class ExpensiveObject(object):
    def __del__(self):
        print '(Deleting %s)' % self</p>

<p>obj = ExpensiveObject()
r = weakref.ref(obj)</p>

<p>print 'obj:', obj
print 'ref:', r
print 'r():', r()</p>

<p>print 'deleting obj'
del obj
print 'r():', r()
</pre></p>

<p>执行：</p>

<p>dongwm@linux-dongwm:~&gt; python test.py
obj: &lt;__main__.ExpensiveObject object at 0xb73cfe2c&gt;
ref: &lt;weakref at 0xb73d06e4; to 'ExpensiveObject' at 0xb73cfe2c&gt;
r(): &lt;__main__.ExpensiveObject object at 0xb73cfe2c&gt;  #一个弱引用
deleting obj
(Deleting &lt;__main__.ExpensiveObject object at 0xb73cfe2c&gt;)
r(): None   #这个引用删除就没有了
<pre class="sh_python">
import weakref</p>

<p>class ExpensiveObject(object):
    def __del__(self):
        print '(Deleting %s)' % self</p>

<p>def callback(reference):  #回调函数
    print 'callback(', reference, ')'</p>

<p>obj = ExpensiveObject()
r = weakref.ref(obj, callback) #当弱引用被删除会调用回调函数</p>

<p>print 'obj:', obj
print 'ref:', r
print 'r():', r()</p>

<p>print 'deleting obj'
del obj
print 'r():', r()
</pre></p>

<p>执行结果：</p>

<p>dongwm@linux-dongwm:~&gt; python test.py
obj: &lt;__main__.ExpensiveObject object at 0xb74c2eec&gt;
ref: &lt;weakref at 0xb74c370c; to 'ExpensiveObject' at 0xb74c2eec&gt;
r(): &lt;__main__.ExpensiveObject object at 0xb74c2eec&gt;
deleting obj
callback( &lt;weakref at 0xb74c370c; dead&gt; )
(Deleting &lt;__main__.ExpensiveObject object at 0xb74c2eec&gt;)
r(): None</p>

<p><pre class="sh_python">
import weakref</p>

<p>class ExpensiveObject(object):
    def __init__(self, name):
        self.name = name
    def __del__(self):
        print '(Deleting %s)' % self</p>

<p>obj = ExpensiveObject('My Object')
r = weakref.ref(obj)
p = weakref.proxy(obj) #弱引用代理</p>

<p>print 'via obj:', obj.name
print 'via ref:', r().name
print 'via proxy:', p.name
del obj
print 'via proxy:', p.name
</pre></p>

<p>执行结果：</p>

<p>dongwm@linux-dongwm:~&gt; python test.py
via obj: My Object
via ref: My Object
via proxy: My Object
(Deleting &lt;__main__.ExpensiveObject object at 0xb72f9eec&gt;)
via proxy:
Traceback (most recent call last):  #<tt>因为引用不存在了，触发ReferenceError</tt>
File "test.py", line 17, in &lt;module&gt;
print 'via proxy:', p.name
ReferenceError: weakly-referenced object no longer exists</p>

<p>&nbsp;</p>
