---
layout: post
title: pymongo教程（二）
categories:
- mongodb
- python
tags:
- pymongo
published: true
comments: true
indexer: true
---
<p>1  移除子文档：</p>

<p>user_doc = {
"username":"foouser",
"emails":[
{
"email":"foouser1@dongwm.com",
"primary":True
},
{
"email":"foouser2@dongwm.com",
"primary":False
},
{
"email":"foouser3@dongwm.com",
"primary":False
}
]
}
dbh.users.insert(user_doc, safe=True)
dbh.users.update({"username":"foouser"},
{"$pull":{"emails":{"email":"foouser2@dongwm.com"}}}, safe=True)   #移除 "foouser2@dongwm.com"子文档</p>

<p>2 增加子文档</p>

<p>new_email = {"email":"fooemail4@dongwm.com", "primary":False}
dbh.users.update({"username":"foouser"},
{"$push":{"emails":new_email}}, safe=True)   #使用$push增加</p>

<p>3 修改子文档</p>

<p>user_doc = {
"username":"foouser",
"emails":[
{
"email":"foouser1@dongwm.com",
"primary":True
},
{
"email":"foouser2@dongwm.com",
"primary":False
},
{
"email":"foouser3@dongwm.com",
"primary":False
}
]
}
dbh.users.insert(user_doc, safe=True)
dbh.users.update({"emails.email":"foouser2@dongwm.com"},
{"$set":{"emails.$.primary":True}}, safe=True)   #设置子文档属性 "primary"为真</p>

<p>4 使用索引加快查找</p>

<p>这里有个文档</p>

<p>user_doc = {
"username":"foouser",
"emails":[
{
"email":"foouser1@dongwm.com",
"primary":True
},
{
"email":"foouser2@dongwm.com",
"primary":False
},
{
"email":"foouser3@dongwm.com",
"primary":False
}
]
}</p>

<p>dbh.users.insert(user_doc)</p>

<p>正常查找使用：</p>

<p>user = dbh.users.find_one({"emails.email":"foouser2@dongwm.com"})</p>

<p>使用索引（根据mail.mail）：</p>

<p>dbh.users.create_index("emails.email")</p>

<p>注：简历索引比较耗时也增加系统负荷可以使用将其放在后台：dbh.users.create_index("emails.email", background=True)</p>

<p>5 删除索引</p>

<p>dbh.users.create_index("username", name="username_idx")
dbh.users.drop_index("username_idx")
6 复合索引（简单的理解就是在where条件中字段用索引，如果用多字段就用复合索引）</p>

<p>dbh.users.create_index([("first_name", pymongo.ASCENDING), ("last_name", pymongo.ASCENDING)])</p>

<p>注：删除索引方法：dbh.users.drop_index([("first_name", pymongo.ASCENDING), ("last_name", pymongo.ASCENDING)])</p>

<p>或者：</p>

<p>dbh.users.create_index([
("first_name", pymongo.ASCENDING),
("last_name", pymongo.ASCENDING)
],
name="name_idx")  #给索引使用一个名字</p>

<p>7 geospatial（<span>地理位置</span>）索引</p>

<p>这个说来比较复杂：可以关注http://blog.nosqlfan.com/html/1811.html以及mongodbCTO的个人博客http://www.snailinaturtleneck.com/blog/</p>

<p>dbh.users.create_index([("user_location", pymongo.GEO2D), ("username", pymongo.ASCENDING)])</p>

<p>8 例子（在点（40,40）最大距离为5的最近的10个用户）</p>

<p>nearest_users = dbh.users.find(
{"user_location":
{"$near" : [40, 40],
"$maxDistance":5}}).limit(10)   #关键字：$near
for user in nearest_users:
print "User %s is at location %s,%s" %(user["username"], user["user_location"][0],user["user_location"[1])</p>

<p>9 例子2（相关区域内的查找）</p>

<p>box = [[50.73083, -83.99756], [50.741404,  -83.988135]]
users_in_boundary = dbh.users.find({"user_location":{"$within": {"$box":box}}})</p>

<p>10 例子3（一个圆区域的查询，提供中心点和半径）</p>

<p>users_in_circle = dbh.users.find({"user_location":{"$within":{"$center":[40, 40, 5]}}}).limit(10)  （点（40,40）,半径为5内的区域查询，只要前10个数据）</p>

<p>11 例子4（球形区域查询）：</p>

<p>earth_radius_km = 6371.0
max_distance_km = 5.0
max_distance_radians = max_distance_km / earth_radius_km
nearest_users = dbh.users.find(
{"user_location":
{"$nearSphere" : [40, 40],
"$maxDistance":max_distance_radians}}).limit(10)   #还是点（40,40）,半径为5内的区域查询，只要前10个数据</p>

<p>12 避免KeyErrors和其他错误，使用默认值</p>

<p>比如计算分数，假如因为某些原因出现错误，为了不影响正常使用，例如将出现问题的那一次运算设计成0：</p>

<p>total_score = 0
for username in ("jill", "sam", "cathy"):
user_doc = dbh.users.find_one({"username":username})
total_score += user_doc.get("score", 0)  #这样的话 有数据的就加数据 没有数据就是0</p>

<p>注：也可能存在不是空值而是空列表</p>

<p>for supplier in product_doc.get("suppliers", []):
email_supplier(supplier)
13 插入或者更新的选择：</p>

<p>先查询是否已经存在的文档，没有选择插入，有的话就是更新</p>

<p>def edit_or_add_session(description, session_id):
dbh.sessions.update({"session_id":session_id},
{"$set":{"session_description":description}}, safe=True, upsert=True)</p>

<p>14 自动增加文档属性值</p>

<p>ret = dbh.users.find_and_modify({"username":username},
{"$inc":{"account_balance":20}}, safe=True, new=True)
new_account_balance = ret["account_balance"]  #"account_balance"自动加了20</p>

<p>&nbsp;</p>
