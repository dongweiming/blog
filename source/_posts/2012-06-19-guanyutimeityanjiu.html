---
layout: post
title: 关于timeit研究
categories:
- python模块研究
tags:
- timeit
published: true
comments: true
indexer: true
---
<p>前言：timeit是一个计时工具模块</p>

<p><pre class="sh_python">
import timeit</p>

<p>t = timeit.Timer("print 'main statement'", "print 'setup'")  #第一个参数是要计时的语句，第二个参数是为第一个参数语句构建环境的导入语句</p>

<p>print 'TIMEIT:'
print t.timeit(2)</p>

<p>print 'REPEAT:'
print t.repeat(3, 3) #第一个参数是重复整个测试的次数，第2个参数是每个测试中调用被计时语句的次数
</pre></p>

<p>执行结果：</p>

<p>dongwm@linux-dongwm:~&gt; python test.py
TIMEIT:
setup
main statement
main statement
5.00679016113e-06
REPEAT:
setup
main statement
main statement
main statement
setup
main statement
main statement
main statement
setup
main statement
main statement
main statement
[5.0067901611328125e-06, 5.0067901611328125e-06, 5.0067901611328125e-06]
<pre class="sh_python">
import timeit
import sys</p>

<p>range_size=1000
count=1000
setup_statement="l = [ (str(x), x) for x in range(%d) ]; d = {}" % range_size
def show_results(result):
    "Print results in terms of microseconds per pass and per item."
    global count, range_size
    per_pass = 1000000 * (result / count) #每次计数占用的微秒
    print '%.2f usec/pass' % per_pass,
    per_item = per_pass / range_size  #每次项目迭代占用的微秒
    print '%.2f usec/item' % per_item</p>

<p>print "%d items" % range_size
print "%d iterations" % count
print
print '__setitem__:\t',
sys.stdout.flush()
# using setitem
t = timeit.Timer("""
for s, i in l:
    d[s] = i
""",
setup_statement)
show_results(t.timeit(number=count)) #返回使用<tt>__setitem__</tt>函数（避免覆盖已在字典中的值）的效果计算，这个最快
print 'setdefault:\t',
sys.stdout.flush()
t = timeit.Timer("""
for s, i in l:
    d.setdefault(s, i) #
""",
setup_statement)
show_results(t.timeit(number=count)) #返回setdefault函数（假如字典存在不覆盖，不存在赋值)已的效果计算
print 'has_key:\t',
sys.stdout.flush()
# using setitem
t = timeit.Timer("""
for s, i in l:
    if not d.has_key(s):
        d[s] = i
""",
setup_statement)
show_results(t.timeit(number=count))#返回<tt>has_key函数（判断字典存在key不覆盖，不存在赋值）</tt>的效果计算
print 'KeyError:\t',
sys.stdout.flush()
# using setitem
t = timeit.Timer("""
for s, i in l:
    try:
        existing = d[s]
    except KeyError:
        d[s] = i
""",
setup_statement)
show_results(t.timeit(number=count)) #返回<em>判断不存在赋值时候异常引起KeyError</em>的效果计算
print '"not in":\t',
sys.stdout.flush()
# using setitem
t = timeit.Timer("""
for s, i in l:
    if s not in d:
        d[s] = i
""",
setup_statement)
show_results(t.timeit(number=count)) #返回'not in'的方式的效果计算
</pre></p>

<p>执行结果：</p>

<p>dongwm@linux-dongwm:~&gt; python test.py
1000 items
1000 iterations</p>

<p>__setitem__:    80.00 usec/pass 0.08 usec/item
setdefault:    175.76 usec/pass 0.18 usec/item
has_key:    116.62 usec/pass 0.12 usec/item
KeyError:    86.06 usec/pass 0.09 usec/item
"not in":    60.73 usec/pass 0.06 usec/item
注：还可以从终端直接导入模块执行：</p>

<p>dongwm@linux-dongwm:~&gt;  python -m timeit -s "d={}" "for i in range(1000):" "  d[str(i)] = i"
1000 loops, best of 3: 296 usec per loop
还可以创建一个py文件 import进来的方式(假设这个文件叫做：timeit_setitem.py)：</p>

<p><pre class="sh_python">
def test_setitem(range_size=1000):
    l = [ (str(x), x) for x in range(range_size) ]
    d = {}
    for s, i in l:
        d[s] = i
</pre></p>

<p>执行结果：</p>

<p>dongwm@linux-dongwm:~&gt; python -m timeit "import timeit_setitem; timeit_setitem.test_setitem()"
1000 loops, best of 3: 384 usec per loop</p>
