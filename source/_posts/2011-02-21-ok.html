---
layout: post
title: 使用crush-tools分析apache访问日志
categories:
- linux基础
- 其它
tags:
- crush-tools
published: true
comments: true
indexer: true
---
<p><strong>crush（Custom Reporting Utilities for SHell）是用于处理数据的工具包，在这里我用来分析apache访问日志，它的网址是http://code.google.com/p/crush-tools/，我所要说的是其强大的性能和功能。</strong></p>

<p><strong>1  下载安装：</strong></p>

<p><pre class="sh_bash"># wget http://crush-tools.googlecode.com/files/crush-tools-2010-03.tar.gz &amp;&amp; tar zxvf crush-tools-2010-03.tar.gz &amp;&amp; cd crush-tools-2010-03  &amp;&amp; ./configure --prefix=/opt/dongwm &amp;&amp; make &amp;&amp; make install</pre></p>

<p>将其加入$PATH以便操作：</p>

<p>#export PATH=$PATH:/opt/dongwm/bin</p>

<p><strong>2  介绍本文使用到的工具包主要的命令：</strong></p>

<p>aggregates 将分离数据集合，比如想知道某网页某段时间的访问量</p>

<p>csvformat  将文件转换成csv格式</p>

<p><tt>convdate  将数据转换日期格式，比如我们想按天统计</tt></p>

<p>cutfield    当取得的数据有些不重要,可以使用此参数去掉那些列</p>

<p><strong>3  设置：</strong></p>

<p><strong>1  设置apache访问日志格式：</strong></p>

<p>我使用默认的apache访问日志格式（httpd.conf中定义）：
<pre class="sh_bash">LogFormat "%h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %&gt;s %b" common
LogFormat "%{Referer}i -&gt; %U" referer
LogFormat "%{User-agent}i" agent</pre>
<strong>2  以下是perl脚本，用来格式化日志文件：</strong></p>

<p><pre class="sh_bash">[root@dongwm tmp]# cat  Format.pl
#!/usr/bin/perl -w
use strict;
if (! open LOGFILE,"$ARGV[0]"){
die "logfile not exists!($!)"
}
my $output_delim = $ENV{DELIMITER} || chr(0xfe);
my $VirtualName=$ARGV[1];
# (dropping the RFC 1413 identity field)
print join($output_delim,
qw(IP 日期 时间 方式 页面 返回时间 平均处理时间)),qq(\n);
while (&lt;LOGFILE&gt;) {
if (/((?:\d{1,3})(?:\.\d{1,3}){3}|-)   # 1 IP
(?:,.*)?\s+(\d+-\d+-\d+)\s+       # 2 日期
(\d+:\d+:\d+)\s+                   # 3 时
(GET|POST)\s+                     # 4 方法
"(.*?\.php?)\??.*"\s+             # 5 URL
(\d{3})\s+                        # 6 返回码
(\d+.\d+).*$/x                    # 7 处理时间
)
{
print join($output_delim, ($1,$2,$3,$4,$5,$6,$7,$VirtualName)),qq(\n);
}
}
exit(0);</pre></p>

<p><strong>3 从ZXTM负载均衡设备上提取apache日志，我这里只一行用来说明：</strong></p>

<p><pre class="sh_bash">48.29.102.43 2011-03-15 00:00:22 GET "/Lifeonline/NewIndex.php?MatchType=DWMet" 200 0.025989 7860 "http://www.dongwm.com/Test/DWMetIndex.php?ThisType=Lift" "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; .NET CLR 1.1.4322; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30; MDDC; .NET CLR 3.0.4506.2152; .NET CLR 3.5.30729)"</p>

<p>格式化后：</p>

<p>#./Format.pl zxtm.log www|csvformat</p>

<p>"48.29.102.43","2011-03-15","00:00:22","GET","/Lifeonline/NewIndex.php","200","0.025989","www"</pre></p>

<p>4 几种对网站内容性能测试体验：</p>

<p><strong>1 查看用户访问各页面的数量：</strong></p>

<p><pre class="sh_bash"># ./Format.pl zxtm.log www|aggregate -k 5 -c 5 |csvformat  //其中-k 表示选择第五列作为key选择的主键，输出结果会显示此列，-c表示对第五列的主键进行统计次数，根据上面格式化后的信息可以知道，第五列也就是/Lifeonline/NewIndex.php，计算这个页面访问的次数</p>

<p>输出如下：</p>

<p>"/Lifeonline/NewIndex.php","7"</pre></p>

<p><strong>2 查看网站每页面响应时间最慢时间：</strong></p>

<p><pre class="sh_bash"># ./Format.pl zxtm.log www |aggregate -k 3,5 -x 7</p>

<p>"00:00:20","/OKAdmin/index.php","0.038450"
"00:00:20","/Remoting/gateway.php","0.104104"
"00:00:20","/Remoting/json.php","0.247292"
"00:00:20","/User/UserCenter.php","0.492700"
"00:00:20","/WapAPI/v1.php","0.297009"</pre></p>

<p><strong>3 查找页面影响最慢的页面:</strong></p>

<p><pre class="sh_bash"># ./Format.pl zxtm.log www|aggregate -p  -K 平均处理时间,页面|csvformat</p>

<p>"0.766413","/Buy/UserBetList.php"
"0.871648","/Lottery06/SportterySoccer/SportteryTest.php"
"1.021357","/Lottery06/SportterySoccer/SportteryTest.php"
"2.170618","/Buy/UserBetList.php"
"3.906909","/Buy06/PassStat.php"</p>

<p>注:命令中-k -c -s等小学字母是以前的版本 新版支持大写+相对应的标签  这个命令 最初使用小写参数选项时候出现了一定的报错,但是使用大写参数就可以了,并且再去用小写也可以了,一个BUG</pre></p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>
