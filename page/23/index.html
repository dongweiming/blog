
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>小明明s à domicile</title>
  <meta name="author" content="Dongweiming">
  <meta name="baidu-site-verification" content="VklGG0Kd1k" />

  
  <meta name="description" content="douban dongweiming site">
  <meta name="keywords" content="python, ipython, emacs, github, dongweiming, django, flask, bottle, jinja2, requests, douban, httpie, jedi, mako, plim, react, develop, lisp, ruby, web development, sed, awk, linux, 运维, 运维开发, sentry, tonrado, scrapy, fabric, celery">
             

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dongweiming.github.com/blog/page/23">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script type="text/javascript" src="/javascripts/api.js"></script>
  <script type="text/javascript" src="/javascripts/wordcumulus.js"></script>
  <script type="text/javascript" src="/javascripts/swfobject.js"></script>
  <script type="text/javascript" src="/javascripts/tagcumulus.js"></script>
  <link href="/atom.xml" rel="alternate" title="小明明s à domicile" type="application/atom+xml">
  <script type="text/javascript" src="/javascripts/sh_python.min.js"></script>
<script type="text/javascript" src="/javascripts/sh_bash.min.js"></script>
<script type="text/javascript" src="/javascripts/sh_main.min.js"></script>
<link href="/stylesheets/sh_ide-anjuta.css" rel="stylesheet" type="text/css">

  
<script id="search-results-template" type="text/x-handlebars-template">
  {{#entries}}
    <article>
        <h3>
            <small><time datetime="{{date}}" pubdate>{{date}}</time></small>
            <a href="{{url}}">{{title}}</a>
            <p>tagged: {{ tags }} | category: <a href="/categories/{{category }}">{{category}}</a></p>
        </h3>
    </article>
  {{/entries}}
</script>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20495125-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    onload="sh_highlightDocument('', '.js');">
<a href="http://github.com/dongweiming/">
<img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png" alt="Follower me on GitHub">
</a>
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">小明明s à domicile</a>

      <div class="nav-collapse">
          <ul class="nav">
    <li><a href="/">博客主页</a></li>
    <li><a href="/blog/archives">文章列表</a></li>
    <li><a href="/aboutsite">关于本站</a></li>
    <li><a href="/projects">我的项目</a></li>
    <li><a href="http://dongweiming.github.io/sed_and_awk">sed_and_awk</a></li>
    <li><a href="http://dongweiming.github.io/Expert-Python">Expert-Python</a></li>
    <li><a href="/aboutme">关于我</a></li>
</ul>

          <ul class="nav pull-right" data-subscription="rss">
              <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
          </ul>

        

          
            <form action="/search" method="get" class="pull-right navbar-search">
    <fieldset role ="search">
        <input type="text" id="search-query" name="q" placeholder="Search" autocomplete="off" class="search" />
    </fieldset>
</form>

          
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
      <div class="row-fluid">
      <div class="span9">
  
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/pyqt4pythonchengxuqidonghuamiandanrudanchuxiaoguo/">(Pyqt4)python程序启动画面淡入淡出效果</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-04T00:00:00+08:00" pubdate data-updated="true">Nov 4<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前言：见过很多软件启动程序后会有个启动画面，并且还有个淡入淡出效果。研究了很久终于实现了：</p>

<p><pre class="sh_python">
class SplashScreen(QSplashScreen):</p>

<p>    def __init__(self):
        super(SplashScreen, self).__init__(QPixmap("../image/app.jpg"))   ＃启动程序的图片
        self.setWindowModality(Qt.ApplicationModal)
    def fadeTicker(self):
        self.setWindowOpacity(0) 
        t =0
        while t &lt;=50:
            newOpacity = self.windowOpacity() + 0.02     ＃设置淡入
            if newOpacity &gt; 1:
           #     self.close()
                break</p>

<p>            self.setWindowOpacity(newOpacity)
            self.show()
            t -= 1
            time.sleep(0.04)
        self.show()
        time.sleep(1)
        t =0
        while t &lt;=50:
            newOpacity = self.windowOpacity() - 0.02         ＃设置淡出
            if newOpacity &lt; 0:
                self.close()
                break</p>

<p>            self.setWindowOpacity(newOpacity)
            self.show()
            t += 1
            time.sleep(0.04)</p>

<p>if __name__ == "__main__":
    app = QtGui.QApplication(sys.argv)
    splash = SplashScreen()
    splash.fadeTicker()
    app.processEvents()   ＃设置启动画面不影响其他效果
    QtGui.QApplication.setQuitOnLastWindowClosed(False)          
    window = Window(confdict)       ＃这是qt程序的主类 每个人的这个不同
    window.st()
    splash.finish(window)            ＃启动画面完成启动qt主类
    sys.exit(app.exec_())
</pre></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/shiyongsuperviserangbuwendingchengxusidiaozidongmashangzhongqi/">使用supervise让不稳定程序死掉自动马上重启</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-03T00:00:00+08:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前言：supervise是daemontools的一个工具，可以用来监控linux下程序的进程状态，当程序有一些问题（例如死掉）会根据设置 自动重启。我有一个socket服务器端需要一直监听数据，但是为了保证它不会莫名其妙的死掉而不可知，但是使用ICE(全称Internet Communications Engine)有点大材小用，所以使用了这个supervise自动重启死掉的程序并记录日志</p>

<p><strong>1 下载安装配置：</strong></p>

<p>wget http://cr.yp.to/daemontools/daemontools-0.76.tar.gz</p>

<p>wget http://www.qmail.org/moni.csi.hu/pub/glibc-2.3.1/daemontools-0.76.errno.patch  ＃这个补丁是修复有些操作系统无法编译安装成功，过程中会报错停止的问题</p>

<p>tar xvzf daemontools-0.76.tar.gz</p>

<p>cd admin/daemontools-0.76</p>

<p>patch -Np1 -i ../../daemontools-0.76.errno.patch</p>

<p>package/compile</p>

<p>cd package &amp;&amp;  sed &#8216;s|/command|/usr/sbin|&#8217; boot.inittab &gt; boot.inittab~</p>

<p>mv -f boot.inittab~ boot.inittab &amp;&amp;  cd ../command</p>

<p>sed -e &#8216;s/command:\/usr\/local\/bin:/usr\/local\/sbin:/&#8217;  -e &#8216;s/command\/svc/usr\/sbin\/svc/&#8217; svscanboot &gt; svscanboot~</p>

<p>mv -f svscanboot~ svscanboot &amp;&amp; chmod +x svscanboot</p>

<p>sudo /bin/cp * /usr/sbin</p>

<p>添加： SV:123456:respawn:/usr/sbin/svscanboot  到  /etc/inittab</p>

<p><strong>2 检查是否安装成功：</strong></p>

<p># pstree -p|grep svs ＃然后有下面类似的进程结构（括号中数据会不一样）</p>

<p>|-svscanboot(22011)-+-readproctitle(22014)         |</p>

<p>`-svscan(22013)</p>

<p><strong>3 编辑你要使用supervise的程序和配置文件</strong></p>

<p>首先建立一个目录：</p>

<p>mkdir /home/dongwm/SocketSrv</p>

<p>然后编辑run配置文件：</p>

<p>cat /home/dongwm/SocketSrv/run
#!/bin/sh
echo &#8216;kill Socketsrv&#8230;&#8217;
kill -9 `ps -ef |grep Socketsrv.py |grep -v grep |awk &#8216;{print $2}&#8217;`</p>

<p>echo &#8220;`date +%Y%m%d-%H%M%S`&#8221;
echo &#8216;start Socketsrv&#8230;&#8217;
python Socketsrv.py ＃这个就是你要让它关里的进程程序 就在Socketsrv目录下</p>

<p><strong>4 启动进程：</strong>
为了排错，我使用了日志记录＋日志轮转的方式（）</p>

<p>nohup supervise /home/dongwm/SocketSrv |/usr/sbin/cronolog &#8220;/var/log/Socketsrv.log_%Y%m%d&#8221; &amp;</p>

<p>表示后台运行，将输入定向到/var/log/Socketsrv.log 并且按天分日志
<strong></strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/shiyongcx_freezeduipengyoutahuanoni/">使用cx_Freeze对python程序打包生成多个exe文件</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-28T00:00:00+08:00" pubdate data-updated="true">Oct 28<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前言：使用python程序需要打包成exe忽略python环境的可执行文件，但是网上没有出现一个相对比较好的文档，我这里有一个setup.py:</p>

<p><pre class="sh_python">
from distutils.core import setup
from cx_Freeze import setup, Executable </p>

<p>GUI2Exe = Executable(
      script = "update.py",  ＃对主程序相关文件升级程序
      base = 'Win32GUI',
       )
GUI2Exe2 = Executable(
      script = "main.py",  #主程序
      base = 'Win32GUI',
      icon = r"C:\app.ico",  #自动exe文件的图标
      shortcutName = u"GY终端",  
       )
includeFiles = [
     ( r"C:\dervcer\etc", "../etc"),
     (r"C:\dervcer\log", "../log"),
      (r"C:\dervcer\image", "../image"),
      (r"C:\dervcer\imageformats", "./imageformats")
    ]   #这个地方主要是为了在打包中添加一些源文件，生成至打包目录，其中imageformats是pyqt4里面的插件动态链接库文件目录，要不然无法在winodws下显示系统图标</p>

<p>setup(
        name = "test",
        version = "0.1",
        description = "dongwm",   ＃生成的exe文件的描述
        options = {"build_exe": {"include_files": includeFiles,}}, </p>

<p>        executables = [GUI2Exe,GUI2Exe2])   ＃因为要生成多个exe文件 所以指定了2个执行的“块”
</pre></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/opensuseanzhuangkiba-dock/">Opensuse安装kiba-dock</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-27T00:00:00+08:00" pubdate data-updated="true">Oct 27<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前言：我想很多人都用过ubuntu下的cairo-dock，那么这个kiba－dock真的有点被遗忘，今天突然没事做，回忆了一下刚开始学习ubuntu时候的感觉。</p>

<p>目前opensuse新版本已经不含这个软件了。然后搜索了一下：</p>

<p>wget ftp://ftp.pbone.net/mirror/ftp5.gwdg.de/pub/opensuse/repositories/home:/swyear/openSUSE_11.1/i586/kiba-dock-0.svn862-6.6.i586.rpm
wget ftp://ftp.pbone.net/mirror/ftp5.gwdg.de/pub/opensuse/repositories/home:/swyear/openSUSE_11.1/i586/kiba-plugins-0.svn862-7.6.i586.rpm</p>

<p>但是发现：需要一个比较老的libcrypto.so.0.9.8和libssl.so.0.9.8，但是我的版本已经提高到1.0.0，所以安装时候忽略依赖关系
sudo rpm -ivh kiba-plugins-0.svn862-7.6.i586.rpm kiba-dock-0.svn862-6.6.i586.rpm &#8211;nodeps</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/jiejuepyqtxitongtuopanyoujiancaidanzaidianjiqitaweizhibuyincangxiaoshidewenti/">解决pyqt系统托盘右键菜单在点击其他位置不隐藏（消失）的问题</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-25T00:00:00+08:00" pubdate data-updated="true">Oct 25<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前言：在使用一些软件的时候都发现当你右键点开这个软件的菜单，再点击其他位置这个菜单会隐藏起来。这样不弹出的菜单无法消失，必须点击菜单项或者应用程序窗体才会消失。。pyqt软件也有这个问题。我研究了一下：该菜单的context是默认的应用程序窗体，当窗体获得焦点时，系统托盘的上下文菜单才会消失。</p>

<p>请看我的部分代码：</p>

<p>self.minimizeAction = QtGui.QAction(u&#8221;最小化&#8221;, self,
triggered=self.hide)   ＃这个self是继承QtGui.QMainWindow的类
self.restoreAction = QtGui.QAction(u&#8221;显示菜单&#8221;, self,
triggered=self.show)
self.quitAction = QtGui.QAction(u&#8221;退出&#8221;, self,
triggered=QtGui.qApp.quit)</p>

<p>self.trayIconMenu = QtGui.QMenu(self)
self.trayIconMenu.addAction(self.restoreAction)
self.trayIconMenu.addAction(self.minimizeAction)
self.trayIconMenu.addAction(self.quitAction)
需要将“self.trayIconMenu = QtGui.QMenu(self)”这行修改为“self.trayIconMenu = QtGui.QMenu(QtGui.QApplication.desktop())”  原理是将这个菜单当作一个桌面</p>

<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/pythonchengxubenlipyqt4tuxingchengxuzhongdianjizidongdanchuqqliaotianchuangkou/">python程序（本例pyqt4图形程序）中点击自动弹出QQ聊天窗口</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-24T00:00:00+08:00" pubdate data-updated="true">Oct 24<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前言：很向往点击某网页就能弹出QQ聊天窗口，最近做的一个python程序为了方便用户提交bug，也设计了一个点击自动弹出和我QQ聊天的对话框供大家参考（只剪切了其中一部分）：</p>

<p><pre class="sh_python"></p>

<p>from PyQt4 import QtCore, QtGui
import systray_rc
import threading,os
import re,time
try:
_fromUtf8 = QtCore.QString.fromUtf8
except AttributeError:
_fromUtf8 = lambda s: s
#设计一个界面，可以做成记事本效果，能够打印文件中的文本
class Ui_notepad(object):
def setupUi(self, notepad):
notepad.setObjectName(_fromUtf8("notepad"))
notepad.setWindowTitle(QtGui.QApplication.translate("notepad", "Form", None, QtGui.QApplication.UnicodeUTF8))
self.editor_window = QtGui.QTextEdit(notepad)
self.editor_window.setGeometry(QtCore.QRect(10, 50, 380, 240))
self.editor_window.setObjectName(_fromUtf8("editor_window"))</p>

<p>self.retranslateUi(notepad)
QtCore.QMetaObject.connectSlotsByName(notepad)</p>

<p>def retranslateUi(self, notepad):
pass
class Window(QtGui.QMainWindow):
    def __init__(self):
       # super(Window, self).__init__()
	QtGui.QMainWindow.__init__(self)
        self.iconComboBox = QtGui.QComboBox()
        self.iconComboBox.addItem(
            QtGui.QIcon('../image/app.jpg'), "Dmyz")
	#通知区域图标右键菜单设置,弹出的菜单的行为，包括退出，还原，最小化
        self.minimizeAction = QtGui.QAction(u"最小化", self,
                triggered=self.hide)
        self.restoreAction = QtGui.QAction(u"显示菜单", self,
                triggered=self.showNormal)
        self.quitAction = QtGui.QAction(u"退出", self,
                triggered=QtGui.qApp.quit)
	self.ui = Ui_notepad()
        self.ui.setupUi(self)
        self.trayIconMenu = QtGui.QMenu(self)
        self.trayIconMenu.addAction(self.restoreAction)
        self.trayIconMenu.addAction(self.minimizeAction)
        self.trayIconMenu.addAction(self.quitAction)
        self.trayIcon = QtGui.QSystemTrayIcon(self)
        self.trayIcon.setContextMenu(self.trayIconMenu)
        self.iconComboBox.currentIndexChanged.connect(
            self.setIcon)
        #设置第一个按键 效果退出
        exit = QtGui.QAction(QtGui.QIcon('../image/exit.png'), 'Exit', self)
	exit.setShortcut('Ctrl+Q')
        exit.setStatusTip(u'\u9000\u51fa\u4e3b\u83dc\u5355')
        self.connect(exit, QtCore.SIGNAL('triggered()'), QtCore.SLOT('close()'))
	#设置第二个按键  历史记录
        lishi = QtGui.QAction(QtGui.QIcon('../image/history.png'),u'\u5386\u53f2', self)
	lishi.setShortcut('Ctrl+L')
        lishi.setStatusTip(u'\u5386\u53f2')
        lishi.connect(lishi,QtCore.SIGNAL('triggered()'), self.file_dialog)
	#设置第3个按键  关于信息
	guangyu = QtGui.QAction(QtGui.QIcon('../image/app.jpg'),u'\u5173\u4e8e', self)
	guangyu.setShortcut('Ctrl+K')
        guangyu.setStatusTip(u'\u5173\u4e8e')
        guangyu.connect(guangyu,QtCore.SIGNAL('triggered()'), self.print_text)
	#设置第4个按键 bug提交 弹出QQ对话框
	qq = QtGui.QAction(QtGui.QIcon('../image/QQ.png'),u'BUG\u8bf7\u8054\u7cfb\u6211', self)
	qq.setShortcut('Ctrl+U')
        qq.setStatusTip(u'\u70b9\u51fb\u6253\u5f00QQ')
        qq.connect(qq,QtCore.SIGNAL('triggered()'), self.contqq)</p>

<p>        self.statusBar()
        menubar = self.menuBar()
        file = menubar.addMenu('&amp;Exit')
        file.addAction(exit)
	file2 = menubar.addMenu('&amp;History')
        file2.addAction(lishi)
	file3 = menubar.addMenu('About')
        file3.addAction(guangyu)
	file3 = menubar.addMenu('Contact')
        file3.addAction(qq)
    #设置打开文件 在pyqt4的主餐单里面的记事本区域显示
    def file_dialog(self):
        s = open('../log/Communicate.log','r').read()
	if len(s) == 0:
	    self.atext = u'目前您还没收到什么信息哦^.^'
	    self.ui.editor_window.setPlainText('sdf')
        self.ui.editor_window.setPlainText(self.atext)
    def print_text(self):  #设置打印关于的信息
	self.ui.editor_window.setPlainText(self.text)
    def contqq(self):  #设置打开QQ
	import win32com.client
	ie6=win32com.client.Dispatch("InternetExplorer.Application")
	ie6.Navigate("tencent://message/?exe=qq&amp;menu=yes&amp;Uin=61966225")
	ie6.Visible=1
	while ie6.Busy:
	  time.sleep(1)
</pre></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/shiyongsvntexingshipythonchengxuzidonggengxin/">使用svn特性使python程序自动更新</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-23T00:00:00+08:00" pubdate data-updated="true">Oct 23<span>rd</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前言：本例借用pysvn这个第三方模块实现。原理是对比某2个svn版本的不同的文件列表，根据增加，删除和修改的不同座不同的操作，达到程序的自动更新</p>

<p><pre class="sh_python">
class Svnup:
    def __init__(self,minv,maxv):
        import pysvn
        import getopt, sys, time, string
        import os, urllib
        from urlparse import urlparse
        client = pysvn.Client()
        revision_min = pysvn.Revision( pysvn.opt_revision_kind.number,minv)
        revision_max = pysvn.Revision( pysvn.opt_revision_kind.number,maxv)
        urlObject = urlparse('http://172.16.180.129/project/svnup')
        url = urlObject.scheme+"://"+urlObject.netloc+urllib.quote(urlObject.path.decode(sys.stdin.encoding).encode('utf8'))
    def get_login(self,realm, user, may_save ):
        return True,'dongwm','password', False
    def run(self):
        client.callback_get_login = get_login
        summary = client.diff_summarize(url, revision_min, url, revision_max)
        for changed in summary:
            print changed['summarize_kind']
            if pysvn.diff_summarize_kind.delete == changed['summarize_kind']:
              fullPath = "../"+changed['path']
              if os.path.exists(fullPath):
                os.remove(fullPath)</p>

<p>            if pysvn.diff_summarize_kind.added == changed['summarize_kind'] or pysvn.diff_summarize_kind.modified == changed['summarize_kind']:
                print changed['summarize_kind'], changed['path']
                if changed['node_kind'] == pysvn.node_kind.file:
                    file_text = client.cat(url+urllib.quote(changed['path'].encode('utf8')), revision_max)
                    fullPath = "../"+changed['path']
                    dirPath = fullPath[0:fullPath.rfind("/")]
                    if not os.path.exists(dirPath):
                        os.makedirs(dirPath)
                    f = open(fullPath,'wb')
                    f.write(file_text)
                    f.close
svnup =Svnup(svn-min,svn-max)
svnup.run()
</pre></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/cepfuzashijianchuliduogejieguotongchuangkouzhanshi/">复杂事件（cep）处理多个结果同窗口展示</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-18T00:00:00+08:00" pubdate data-updated="true">Sep 18<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>展示效果类似于dstat（python）将日志文件的结果格式化显示到终端界面</p>

<p><pre class="sh_perl">
#!/usr/bin/perl -w</p>

<p>use strict;
no strict 'refs';
use Getopt::Long;
use Pod::Usage;
use Term::ReadKey;
use Time::HiRes qw ( time alarm sleep );
Getopt::Long::Configure('bundling');</p>

<p>#####初始化变量######
my @ltime=localtime();
my $date=sprintf("%d-%d-%d",$ltime[5]+1900,$ltime[4]+1,$ltime[3]);
my $cfgfile='/cepdata/conf/cepstat.cfg';</p>

<p>###获取配置文件内容###
my %config;
get_config();
my $LogPath=$config{main}-&gt;{logpath};</p>

<p>###参数选项####
my @opt_spec=(
	{ s =&gt; 'h', d =&gt; 'display help message'},
	{ s =&gt; 't', d =&gt; 'display system time'},
);</p>

<p>foreach my $page (keys %{$config{pagelist}}) {
	my $href = { s=&gt;$config{pagelist}{$page}-&gt;{argc},d=&gt;$config{pagelist}{$page}-&gt;{desc} || $page };  # { s =&gt; 'm', d =&gt; 'some description'  }
	push @opt_spec,$href;
}
###获取命令行参数###
my %opts;
pod2usage(-verbose =&gt; 1,-message =&gt; "Need at least one argument\ntry -h for more information") unless @ARGV;
GetOptions(
	map { $_-&gt;{s} =&gt; \$opts{$_-&gt;{s}} } @opt_spec  # { 'm' =&gt; \$opts{m} }
) or pod2usage(1);</p>

<p>###要输出的日志###
my %pagelist;
map {$pagelist{$config{pagelist}-&gt;{$_}-&gt;{argc}} = $_ if $opts{$config{pagelist}-&gt;{$_}-&gt;{argc}} } keys %{$config{pagelist}} ;  # m =&gt; sumtime</p>

<p>### HELP MESSAGE ###
if ($opts{h}) {
    foreach my $spec (sort {$a-&gt;{s} cmp $b-&gt;{s}}  @opt_spec) {
        printf "  -%-4s %-15s\n",$spec-&gt;{s},$spec-&gt;{d};
    }
    exit 1;
}</p>

<p>###打开文件句柄####
my $lastmtime='0';
foreach my $fh (values %pagelist) {   # m =&gt; sumtime
		my $logfile;
		if ($config{pagelist}-&gt;{$fh}-&gt;{logfile} =~ /^\//) {
			$logfile="$config{pagelist}-&gt;{$fh}-&gt;{logfile}.$date";
		} else {
			$logfile="$LogPath/$config{pagelist}-&gt;{$fh}-&gt;{logfile}.$date";
		}
		my $logmtime=(stat($logfile))[9];
		$lastmtime = $logmtime if ( $logmtime &gt; $lastmtime );
		open $fh,"$logfile" or die "cant open $logfile:$!";
		seek $fh,0,2;
}
my $currenttime=time();
my $sleep = $lastmtime + 5.5 - $currenttime;</p>

<p>#######标题与结果的格式化处理########
	my $resultformat;					#结果输出格式
	my $fieldformat;					#列名输出格式
	my $pagenameformat;					#日志名居中显示
	my $tmp_regex;                      #临时正则
	my @FIELDS;							#存放所有列名的全局数组
	my %FieldCount;
	#循环开始
	foreach my $page (values %pagelist) {											 #对每个日志做处理
#		my $fields = $config{pagelist}-&gt;{$page}-&gt;{fields};                           #取出列名
		my $alias = $config{pagelist}-&gt;{$page}-&gt;{alias};
#		my @Fieldname = split /\s+/,$fields;										 #将列名存入临时数组
		my @Alias = split /\s+/,$alias;
		my $count = @Alias;														 #列名个数
		$FieldCount{$page}=$count;
		my $num = $count;															 #用来计算数组下标
		while ($count) {															 #遍历每个列名
#			$tmp_regex .= $Fieldname[$num -$count] . '=' . '([\w\.]+),.*?';			 #拼接正则表达式
			$tmp_regex .= '=' . '([\w\.]+),.*?';									 #拼接正则表达式
			push @FIELDS,$Alias[$num -$count];										 #将列名存入全局数组
			$count--;
        }
		$tmp_regex =~ s/,\.\*\?$/.*?/;												 #去掉临时正则后多余的字符
	#####页面名居中显示######
		my $tmp_pagename = $config{pagelist}-&gt;{$page}-&gt;{format};					 #从配置文件中取出格式
	# g%7d y%7d p%7d c%10d
		$tmp_pagename =~ s/\.\d*//g;			#去掉浮点数 1.23f -&gt; 1f
		$tmp_pagename =~ s/\s/ 1 /g;			#空格需要占1个字符
		$tmp_pagename =~ s/[^\d\s]//g;			#去掉非数字非空格 如: 7 1 7 1 7 1 10
		my @tmp=split /\s+/,$tmp_pagename;
		my $cnt;
		my $desc = $config{pagelist}-&gt;{$page}-&gt;{desc};
		map { $cnt += $_ } @tmp;				#得出共占多少字符
		my $pagenameleft = sprintf "%d",($cnt - length($desc))/ 2;			#计算页面名前后有多少字符
		my $pagenameright = $cnt - length($desc) - $pagenameleft;
		my $tt = '-' x $pagenameleft . $desc . '-' x $pagenameright . ' ';  #定好格式
		$pagenameformat .= $tt;					#将每个页面临时格式拼接起来</p>

<p>		$resultformat .= $config{pagelist}-&gt;{$page}-&gt;{format} . '|';                           #拼接结果输出格式
	}
	#循环结束</p>

<p>	my $regex = qr/$tmp_regex/;                                     #构建正则表达式，存入变量中
	#页面名头尾加颜色代码
	$pagenameformat = '---sys--' . ' ' . $pagenameformat if ($opts{t});
	$pagenameformat =~ s/^/\e[0;34m/;
	$pagenameformat =~ s/$/\e[0m/;</p>

<p>	#每个列名后加颜色代码
	$resultformat =~ s/\|$//;										#去掉结果输出格式最后的分割线 |
    $fieldformat = $resultformat;                                   #列名的输出格式               g%7d y%7d p%7d c%10d|r%10s y%7s
    $fieldformat =~ s/\.\d+f|d/s/g;                                 #列名都为字符串，将d,f转成s   g%7s y%7s p%7s c%10s|r%10s y%7s
	$fieldformat =~ s/\w?(?=%)/\e[1;4;34m/g;
	$fieldformat =~ s/(?=\s|$)/\e[0m/g;								#转为\e[1;4;34m%7s\e[0m ..... 高亮下划线蓝色
	$fieldformat =~ s/(?=\|)/\e[0;34m/g;							# | 为普通蓝色</p>

<p>	#结果格式预处理
	$resultformat =~ s/(?=\s|$)/\e[0m/g;							#转为 g%7d\e[0m y%7d\e[0m
	$resultformat =~ s/(?=\|)/\e[0;34m/g;							# | 为普通蓝色
	my @MasterColor;												#默认颜色的数组
	push @MasterColor,$1 while ($resultformat =~ s/(\w)%/!%/);		#格式转为 !%7d\e[0m !%7d\e[0m  数组内容 (g y p c r y)</p>

<p>	my $lines_left;												#终端所剩行数
	my @OldData=();												#日志最后一行匹配出的结果，用来与新数据比较
	my @NewData;
######主循环######
print "Waiting for new data......\n";
sleep $sleep if ($sleep &gt; 0);
while (1) {
		my $logline;
		PrintTitle() unless $lines_left;					#打印标题栏
		foreach my $page (values %pagelist) {				#从每个日志文件读入一行
			if (my $line = &lt;$page&gt;) {
			chomp($line);
			$logline .= $line . " ";						#所有行拼接起来
			} else {
					my $count = $FieldCount{$page};
					$logline .= '=0,' while ($count--);
					$logline =~ s/,$/ /;
				}
			}
		if (@NewData = $logline =~ $regex) {						#匹配出新数据
			@OldData = @NewData unless @OldData;
			CheckThreshold();								#与旧数据比较并打印
			$lines_left--;									#所剩行数 -1
		}
		sleep 5;
}</p>

<p>sub PrintTitle{
    $lines_left = (GetTerminalSize())[1] ;                              #获取行数
	print "$pagenameformat\n";
	print "\e[1;4;34m  time  \e[0;34m|" if $opts{t};
	printf "$fieldformat\n",@FIELDS;
	$lines_left -= 3;
}</p>

<p>sub get_config
{
    open CEPCONF,"&lt;$cfgfile" or die "can't open configfile!"; #打开配置文件
    while (&lt;CEPCONF&gt;) {
        next if /^$/;           #忽略空行
        next if /^\s*\#/;       #忽略注释
        if (my ($menu) = /\[(\w+)\]/) {     #遇到[a]
                while (&lt;CEPCONF&gt;) {         #循环读取[a]下的内容
                    next if /^$/;
                    next if /^\s*\#/;
                    last if /\[\/(\w+)\]/;  #如果遇到[/a]结束此循环
                    chomp;
                    if (my ($pagename) = /\[(\w+)\]/) { #又遇到[b]
                        while (&lt;CEPCONF&gt;) {             #循环读取[]下的内容
                        next if /^$/;
                        next if /^\s*\#/;
                        last if /\[\/(\w+)\]/;          #如果遇到[/b]结束此循环
                        chomp;
                        my ($cfg_key,$cfg_value)= split /=/;    #获取以=分隔的变量名，变量值
                        $cfg_key =~ s/^\s+|\s+$//g;             #去掉变量名前后的空白字符
                        $cfg_value =~ s/\#.*$//g;               #去掉变量值后的注释
                        $cfg_value =~ s/^\s+|\s+$//g;           #去掉变量值前后的空白字符
                        $cfg_value =~ s/['"]//g;                #去掉变量值前后的引号
                        $config{$menu}-&gt;{$pagename}-&gt;{$cfg_key}=$cfg_value;     #将变量名、变量值存入hash $config{a}-&gt;{b}-&gt;{变量名}=变量值
                            }
                        }
                    next if /\[\/(\w+)\]/;              #遇到[/b]跳过
                    my ($cfg_key,$cfg_value)= split /=/;        #获取以=分隔的变量名，变量值
                $cfg_key =~ s/^\s+|\s+$//g;                 #同上
            $cfg_value =~ s/\#.*$//g;
        $cfg_value =~ s/^\s+|\s+$//g;
        $cfg_value =~ s/['"]//g;                    #去掉变量值前后的引号
    $config{$menu}-&gt;{$cfg_key} = $cfg_value;    #存入hash $config{a}-&gt;{变量名}=变量值
            }
        }
    }
    close CEPCONF;      #关闭文件句柄
}           </p>

<p>sub CheckThreshold{</p>

<p>	my $threadformat=$resultformat;						#格式 !%7d\e[0m !%7d\e[0m
	my $numrel=@NewData;
	my $cnt=$numrel;											#用来计算下标
	my @format;
	while ($cnt) {
		my $xiabiao=$numrel-$cnt;
		$NewData[$xiabiao] =~ s/null/0/;
		if ($NewData[$xiabiao] =~ /[a-z\.]+/) {				#非数字不比较，直接更新到旧数据数组
			$format[$xiabiao]=$MasterColor[$xiabiao];	#取默认颜色
			$cnt--;
			next;
		} elsif  ($NewData[$xiabiao] == 0 ) {			#值为0,转变为白色
			$format[$xiabiao]='w';
			$cnt--;
			next;
			}
		if ( abs($NewData[$xiabiao]  - $OldData[$xiabiao] + 0) /($OldData[$xiabiao] + 1 ) &gt; 0.5 ) {
			$format[$xiabiao]='z';						#新数据变化率超过阀值，转变为高亮红色，不更新到旧数据数据
        } else {
			$format[$xiabiao]=$MasterColor[$xiabiao];	#未超过阀值,取默认颜色
			$OldData[$xiabiao]=$NewData[$xiabiao];		#更新到旧数据数组
		}
		$cnt--;
	}</p>

<p>	map { $threadformat =~ s/!/$_/} @format;			#g%7d\e[0m y%7d\e[0m ....</p>

<p>	$threadformat =~ s/z/\e[1;31m/g;
#	$threadformat =~ s/r/\e[0;31m/g;
	$threadformat =~ s/g/\e[1;32m/g;
	$threadformat =~ s/y/\e[1;33m/g;
	$threadformat =~ s/b/\e[0;34m/g;
	$threadformat =~ s/p/\e[1;35m/g;
	$threadformat =~ s/c/\e[1;36m/g;
	$threadformat =~ s/w/\e[0;37m/g;</p>

<p>	if ($opts{t}) {
		my @localtime=localtime;
		my $time=sprintf("%02d:%02d:%02d",$localtime[2],$localtime[1],$localtime[0]);
		print "\e[0;37m$time\e[0;34m|";
		}</p>

<p>	printf "$threadformat\n",@NewData;
}
</pre></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/jiyuconsolezhongduandejiaohusocketliaotianchengxukehuduan/">基于console终端的交互socket聊天程序（客户端）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-16T00:00:00+08:00" pubdate data-updated="true">Sep 16<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前言：这是初步学习的一个练习，需要实现多线程池，使用MySQLdb模块，并发等。但是实际工作发现，不能使用多进程将接受和发送socket分离，因为raw_input需要console支持，所以只能通过多线程+多线程实现。文中还实现了一个显示进度的“旋转竖线”效果，解决了多线程无法CTRL＋C 退出的问题</p>

<p><pre class="sh_python">
#!/usr/bin/env python
#-*- coding: utf8 -*-</p>

<p>import os,socket, sys, time,traceback,signal
from time import ctime
from threading import *
from optparse import OptionParser
import MySQLdb
#from multiprocessing import Process</p>

<p>host = '192.168.8.46'
textport = '8888'
cv = Condition()  #Condition比lock功能多
spinners = '|/-\\'
spinpos = 0
equeue = []</p>

<p>class MYmsg:
    '''主要是一些信息输出的线程定义以及线程模板'''
    #接受用户input信息
    def fwrite(self,buf):
        sys.stdout.write(buf)
        sys.stdout.flush()
#旋转竖线定义
    def spin(self):
        global spinners, spinpos
        self.fwrite(spinners[spinpos] + "\b")
        spinpos += 1
        if spinpos &gt;= len(spinners):
            spinpos = 0
#把旋转竖线放入线程，运行用户接口,调用wait()使竖线旋转
    def uithread(self):
        global cv, equeue
        while 1:
            cv.acquire()
            while not len(equeue):
                cv.wait(0.15)
                self.spin()</p>

<p>            msg = equeue.pop(0)
            cv.release()
            if msg == 'QUIT':
                self.fwrite("\n")
                sys.exit(0)
            self.fwrite(" \n  %s\r" % msg)
#把打印信息放入线程，调用notify(),添加队列通知其他线程
    def msg(self,message):
        global cv, equeue
        cv.acquire()
        equeue.append(message)
        cv.notify()
        cv.release()
#定义的线程模板方法
    def mythread(self,myth,flag=0):
        if flag:
            t = Thread(target = myth,args = [arg])
        else:
            t = Thread(target = myth)
        t.setDaemon(True)
        t.start()</p>

<p>class Watcher:
    '''用新进程来接受信号后杀掉执行任务进程,主要解决多线程只能杀掉主线程的问题，无法ctrl +c 退出'''
#创建一个子线程，它返回父线程等待一个KeyboardInterrupt，然后杀死子线程
    def __init__(self):
        self.child = os.fork()
        if self.child == 0:
            return
        else:
            self.watch()
    def watch(self):
        try:
            os.wait()
        except KeyboardInterrupt:
            print 'KeyBoardInterrupt'
            self.kill()
        sys.exit()
    def kill(self):
        try:
            os.kill(self.child, signal.SIGKILL)
        except OSError:
            pass</p>

<p>class MYconnt(MYmsg):
    '''
    socket连接，打印信息，异常处理
    '''
    def __init__(self):
        self.msg=MYmsg()
    def connt(self):
        self.msg.mythread(self.uithread)  #使用旋转竖线
        try:
            self.msg.msg('Creating socket object')
            time.sleep(3)</p>

<p>            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        except socket.error, e:
            print "Strange error creating socket: %s" % e
            sys.exit(1)</p>

<p>        try:
            port = int(textport)
        except ValueError:
            try:
                port = socket.getservbyname(textport, 'tcp')
            except socket.error, e:
                print "Couldn't find your port: %s" % e
                sys.exit(1)</p>

<p>        self.msg.msg('Connecting to %s:%d' % (host, port))
        time.sleep(2)
        try:
            s.connect((host, port))
        except socket.gaierror, e:
            print "Address-related error connecting to server: %s" % e
            sys.exit(1)
        except socket.error, e:
            print "Connection error: %s" % e
            sys.exit(1)
        self.msg.msg("QUIT")
        return s</p>

<p>class MYtalk(MYconnt):
    '''
    聊天程序接受和发送
    '''
    def __init__(self):
        self.myconnt=MYconnt()
        self.s = self.myconnt.connt()
#根据参数选择发送或者接收socket信息
    def choice(self,th):
        self.mysqlconnt = mysqldb()
        if th == 'sed':
            while 1:
                try:
                    buf = self.s.recv(2048)
                except socket.error, e:
                    print "Error receiving data: %s" % e
                    sys.exit(1)
                except KeyboardInterrupt:
                    raise
                    self.mysqlconnt.close()
                if not len(buf):
                    break
                print "%s says: %s" % (self.s.getpeername(),buf)
                self.mysqlconnt.insert('Client',self.s.getpeername()[0],buf.split(']')[0][1:],buf.split(']')[1])
        elif th == 'rev':
            while 1:</p>

<p>                try:
                    sys.stdout.write('&gt;')
                    self.data = sys.stdin.readline()
                    sys.stdout.flush()
                    if not self.data:
                        break
                    elif self.data == "quit":
                        try:
                            self.s.shutdown(1)
                        except socket.error, e:
                            print "Error sending data (detected by shutdown): %s" % e
                            sys.exit(1)</p>

<p>                    self.s.sendall('[%s] %s' % (ctime(),self.data))
                    self.mysqlconnt.insert('Client',socket.gethostbyname(socket.gethostname()),ctime(),self.data)
                except KeyboardInterrupt:
                    raise</p>

<p>                except socket.error, e:
                    print "Error sending data: %s" % e
                    sys.exit(1)
#将接收和发送放在不同的进程
    def process(self):
        plist = []
        for th in ['rev','sed']:
            p = Process(target=self.choice,args = [th])
            plist.append(p)
            p.start()
        for p in plist:
            p.join()
#将接收和发送放在不同的线程
    def mthread(self):
         mlist = []
         for th in ['rev','sed']:
             Watcher()
             t = Thread(target = self.choice,args = [th])
             mlist.append(t)
             t.setDaemon(1)
             t.start()
         for t in mlist:
             t.join()</p>

<p>class mysqldb:
    def __init__(self):
        try :
            self.conn = MySQLdb.connect(host = "192.168.8.46",user = "dongwm",passwd = "test123",db = "talk")
        except MySQLdb.Error, e:
            print "Error %d: %s" % (e.args[0], e.args[1])
            sys.exit (1)
        try :
            self.cursor = self.conn.cursor()
        except :
            raise
    def insert(self,table,ip,time,text):
        sql = "insert into %s(ip,time,text) values('%s','%s','%s');" % (table,ip,time,text)
        try:
            self.cursor.execute(sql)
        except Exception,e:
            print  e
    def select(self,table):
        sql = "select * from %s;" % table
        try:
            self.cursor.execute(sql)
        except Exception,e:
            print e
        for data in self.cursor.fetchall():
            print '%s\t%s\t%s' % data
    def close():
        self.cursor.close()
        self.conn.commit()
        self.conn.close()
#主函数
if __name__ == '__main__':
    argc = len(sys.argv)
    parser = OptionParser(description="Socket Talk Shell",add_help_option=False,prog="Client.py",version="1.0",usage="%prog")
    parser.add_option("-h", "--help",action = "help",help="print help")
    parser.add_option("-p", "--print",action="store_true",help="print data in mysql")
    options, arguments=parser.parse_args()
    if argc == 1:
        mytalk=MYtalk()
        mytalk.mthread()
    if '-h' in sys.argv  or '--help' in sys.argv:
        print __doc__
    elif '-p'  in sys.argv  or '--print' in sys.argv:
        mysqldbconnt=mysqldb()
        mysqldbconnt.select('Client')
    else:
       print 'Please run this script without parameters'
</pre></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/jiyuconsolezhongduandejiaohusocketliaotianchengxufuwuqiduan/">基于console终端的交互socket聊天程序（服务器端）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-16T00:00:00+08:00" pubdate data-updated="true">Sep 16<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前言：这个socket程序和客户端一起，其中mysqldb模块操作是import client</p>

<p><pre class="sh_python">
#!/usr/bin/env python
#-*- coding: utf8 -*-
'''just a Just a server-side script'''
import socket, traceback, os, sys, time
from time import ctime
from threading import *
from client import mysqldb
from optparse import OptionParser</p>

<p>host = ''
port = 8888
MAXTHREADS = 3
lockpool = Lock()
busylist = {}
waitinglist = {}
queue = []
sem = Semaphore(0) #当计数器为0时，acquire()将阻塞线程至同步锁定状态，直到其他线程调用release()</p>

<p>class MYthread(mysqldb):
    def handleconnt(self,clientsock,choice):
        lockpool.acquire() #使线程进入同步阻塞状态，尝试获得锁定
        print "Received new client connection."
        #判断等待线程是否到达最大线程数，是，就会关闭socket
        try:
            if len(waitinglist) == 0 and (activeCount() - 1) &gt;= MAXTHREADS:
                clientsock.close()
                return
            if len(waitinglist) == 0:
                self.mythread(choice)
            queue.append(clientsock) #socket加入队列，semaphore被释放
            sem.release()
        finally:
            lockpool.release()
#多线程模板，启动线程
    def mythread(self,myth):
        print "Starting new client processor thread"
        t = Thread(target = self.threadworker,args= [myth])
        t.setDaemon(1)
        t.start()
#多线程运行的函数，处理终止的线程，初始化waitinglist
    def threadworker(self,choice):
        global waitinglist, lockpool, busylist
        time.sleep(1) 
        name = currentThread().getName()
        try:
            lockpool.acquire()
            try:
                waitinglist[name] = 1
            finally:
                lockpool.release()
            self.processclients(choice)
        finally:
            print "** WARNING** Thread %s died" % name
            if name in waitinglist:
                del waitinglist[name]
            if name in busylist:
                del busylist[name]
            self.mythread(choice)
#让接收和发送socket作为2个线程
    def mthread(self,clientsock):
        mlist = []
        for th in ['rev','sed']:
             t = Thread(target = self.handleconnt,args = [clientsock,th])
             mlist.append(t)
             t.setDaemon(1)
             t.start()
        for t in mlist:
             t.join()
#响应客户端连接的处理请求
    def processclients(self,choice):
        global sem, queue, waitinglist, busylist, lockpool
        name = currentThread().getName()
        self.mysqlconnt=mysqldb()</p>

<p>        while 1:
            sem.acquire()
            lockpool.acquire()
            try:
                clientsock = queue.pop(0)
                del waitinglist[name]
                busylist[name] = 1
            finally:
                lockpool.release()</p>

<p>            try:
                print "[%s] Got connection from %s" % \
                        (name, clientsock.getpeername())
                if choice == "sed":
                    while 1:
                        try:
                            sys.stdout.write('&gt;')
                            data = sys.stdin.readline()
                            sys.stdout.flush()
                            if not data:
                                break
                            clientsock.sendall('[%s] %s' % (ctime(),data))
                            self.mysqlconnt.insert('Server',socket.gethostbyname(socket.gethostname()),ctime(),data)
                        except socket.error, e:
                            print "Error sending data : %s" % e
                            sys.exit(1)
                elif choice == "rev":
                     while 1:
                         try:
                             buf = clientsock.recv(2048)
                         except socket.error, e:
                             print "Error receiving data: %s" % e
                             sys.exit(1)
                         if not len(buf):
                             break
                         print "%s says: %s "  % (clientsock.getpeername(),buf)
                         self.mysqlconnt.insert('Server',socket.gethostbyname(socket.gethostname()),ctime(),buf)</p>

<p>            except (KeyboardInterrupt, SystemExit):
                raise
            except:
                traceback.print_exc()</p>

<p>            try:
                clientsock.close()
            except KeyboardInterrupt:
                raise
            except:
                traceback.print_exc()</p>

<p>            lockpool.acquire()
            try:
                del busylist[name]
                waitinglist[name] = 1
            finally:
                lockpool.release()
#接收socket，并且指定MYthread类处理
def listener():
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        s.bind((host, port))
        s.listen(1)</p>

<p>        while 1:
            try:
                clientsock, clientaddr = s.accept()
            except KeyboardInterrupt:
                raise
            except:
                traceback.print_exc()
                continue
            mythread = MYthread()
            mythread.mthread(clientsock)
#主函数
if __name__ == '__main__':
    argc = len(sys.argv)
    parser = OptionParser(description="Socket Talk Shell",add_help_option=False,prog="Client.py",version="1.0",usage="%prog")
    parser.add_option("-h", "--help",action = "help",help="print help")
    parser.add_option("-p", "--print",action="store_true",help="print data in mysql")
    options, arguments=parser.parse_args()
    if argc == 1:
        listener()
    if '-h' in sys.argv  or '--help' in sys.argv:
        print __doc__
    elif '-p'  in sys.argv  or '--print' in sys.argv:
        mysqldbconnt=mysqldb()
        mysqldbconnt.select('Server')
    else:
       print 'Please run this script without parameters'
</pre></p>
</div>
  
  


    </article>
  
  <ul class="pager">
    
    <li class="previous"><a href="/page/24/">&larr; Older</a></li>
    
    <li><a href="/blog/archives">博客文章</a></li>
    
    <li class="next"><a href="/page/22/">Newer &rarr;</a></li>
    
  </ul>
</div>
<aside class="sidebar-nav span3">
  
    <section class='well'>
    <ul id='qq' class='nav'>
        <li class='nav-header'>我新建了一个QQ群</li>
        <li style="padding-left: 15px;">522012167</li>
        <li style="padding-left: 15px;">欢迎入伙</li>
    </ul>
</section>
<section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">最近发布</li>
    
      <li class="post">
        <a href="/archives/%3C%3Cpython-webkai-fa-shi-zhan-%3E%3E-shang-shi-%5B%3F%5D-ge-yue-liao/">《Python-Web开发实战》上市一个月了</a>
      </li>
    
      <li class="post">
        <a href="/archives/python-webkai-fa-shi-zhan-yu-shou-lou/">《Python Web开发实战》预售喽</a>
      </li>
    
      <li class="post">
        <a href="/archives/shi-yong-stridershi-xian-chi-xu-ji-cheng/">使用Strider实现持续集成</a>
      </li>
    
      <li class="post">
        <a href="/archives/fang-djangobookde-markdownwen-zhang-ping-zhu-xi-tong/">仿Djangobook的Markdown文章评注系统</a>
      </li>
    
      <li class="post">
        <a href="/archives/shi-yong-github-webhookfu-wu-shi-xian-ti-przi-dong-jian-cha-flake8bing-zai-dui-ying-wei-zhi-fa-ping-lun/">使用Github webhook服务实现提PR自动检查Flake8并在对应位置发评论</a>
      </li>
    
      <li class="post">
        <a href="/archives/zui-jin-zai-xie-ben-webkai-fa-zhu-ti-de-shu/">最近在写一本Python Web开发的书</a>
      </li>
    
      <li class="post">
        <a href="/archives/codekai-yuan-liao/">CODE开源了</a>
      </li>
    
      <li class="post">
        <a href="/archives/12ge-pythonnao-jin-ji-zhuan-wan/">12个python填空题</a>
      </li>
    
      <li class="post">
        <a href="/archives/wo-li-jie-de-pythonzui-jia-shi-jian/">我理解的python最佳实践</a>
      </li>
    
      <li class="post">
        <a href="/archives/pythonjin-jie-bi-du-hui-zong/">python进阶必读汇总</a>
      </li>
    
  </ul>
</section>
<section class="well">
  <ul id="recent_posts" class="nav nav-list">
  <li class="nav-header">个人网站</li>
    <li class="post"><a href="http://salogs.com">带我入行的boss</a></li>
    <li class="post"><a href="http://dongweiming.github.com/">小明明s Github Blog</a></li>
    <li class="post"><a href="http://youhouer.appspot.com/">Love story(GAE)</a></li>
    <li class="post"><a href="http://www.unixhot.com">unixhot运维社区</a></li>
    <li class="post"><a href="http://www.vpsee.com">Vpsee</a></li>
    <li class="post"><a href="http://dongweiming.github.io/sed_and_awk/">sed_and_awk</a></li>
    <li class="post"><a href="http://dongweiming.github.io/Expert-Python">Expert-Python</a></li>
  </ul>
</section>

<section class="well">
  <ul id="gh_repos" class="nav">
    <li class="nav-header">GitHub帐号</li>
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/dongweiming">@dongweiming</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        github.showRepos({
            user: 'dongweiming',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/asides/github.js" type="text/javascript"> </script>
</section>




<section class="well">
   <ul id="gh_repos" class="nav">
    <li class="nav-header">标签Cloud</li>
  </ul>
  <div id="tag-cloud"></div>
</section>

<section class="well">
  <ul id="gh_repos" class="nav">
    <li class="nav-header">豆瓣阅读</li>
  </ul>
  <script type="text/javascript" src="http://www.douban.com/service/badge/62943420/?select=random&amp;n=10&amp;columns=2&amp;picsize=medium&amp;hidelogo=true&amp;hideself=true&amp;cat=book|music" ></script>
  <a href="https://www.douban.com/people/62943420">@小明明</a> on Douban 
</section>


<section class='well'>
<ul id='gh_repos' class='nav'>
<li class='nav-header'>文章统计</li>
<li>本站共有 271 篇文章</li>
</ul>
</section>


  
</aside>

      </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2016 - Dongweiming -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dongwm';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
