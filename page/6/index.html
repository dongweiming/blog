
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>小明明s à domicile</title>
  <meta name="author" content="Dongweiming">

  
  <meta name="description" content="douban dongweiming site">
  <meta name="keywords" content="python, ipython, emacs, github, dongweiming, django, flask, bottle, jinja2, requests, douban, httpie, jedi, mako, plim, react, develop, lisp, ruby, web development, sed, awk, linux, 运维, 运维开发, sentry, tonrado, scrapy, fabric, celery">
             

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dongweiming.github.com/blog/page/6">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script type="text/javascript" src="/javascripts/api.js"></script>
  <script type="text/javascript" src="/javascripts/wordcumulus.js"></script>
  <script type="text/javascript" src="/javascripts/swfobject.js"></script>
  <script type="text/javascript" src="/javascripts/tagcumulus.js"></script>
  <link href="/atom.xml" rel="alternate" title="小明明s à domicile" type="application/atom+xml">
  <script type="text/javascript" src="/javascripts/sh_python.min.js"></script>
<script type="text/javascript" src="/javascripts/sh_bash.min.js"></script>
<script type="text/javascript" src="/javascripts/sh_main.min.js"></script>
<link href="/stylesheets/sh_ide-anjuta.css" rel="stylesheet" type="text/css">

  
<script id="search-results-template" type="text/x-handlebars-template">
  {{#entries}}
    <article>
        <h3>
            <small><time datetime="{{date}}" pubdate>{{date}}</time></small>
            <a href="{{url}}">{{title}}</a>
            <p>tagged: {{ tags }} | category: <a href="/categories/{{category }}">{{category}}</a></p>
        </h3>
    </article>
  {{/entries}}
</script>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20495125-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    onload="sh_highlightDocument('', '.js');">
<a href="http://github.com/dongweiming/">
<img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png" alt="Follower me on GitHub">
</a>
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">小明明s à domicile</a>

      <div class="nav-collapse">
          <ul class="nav">
    <li><a href="/">博客主页</a></li>
    <li><a href="/blog/archives">文章列表</a></li>
    <li><a href="/aboutsite">关于本站</a></li>
    <li><a href="/projects">我的项目</a></li>
    <li><a href="http://dongweiming.github.io/sed_and_awk">sed_and_awk</a></li>
    <li><a href="http://dongweiming.github.io/Expert-Python">Expert-Python</a></li>
    <li><a href="/aboutme">关于我</a></li>
</ul>

          <ul class="nav pull-right" data-subscription="rss">
              <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
          </ul>

        

          
            <form action="/search" method="get" class="pull-right navbar-search">
    <fieldset role ="search">
        <input type="text" id="search-query" name="q" placeholder="Search" autocomplete="off" class="search" />
    </fieldset>
</form>

          
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
      <div class="row-fluid">
      <div class="span9">
  
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/zi-da-jian-gitfu-wu-qi-shi-xian-ti-jiao-dai-ma-zi-dong-tui-dao-ce-shi-huan-jing/">自搭建git服务器实现提交代码自动推到测试环境</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-17T23:15:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4 id="section">前言</h4>

<p>假如公司有很多项目，很可能你要自建git服务器，然后有不同的分支管理各个项目。尤其是web开发，每次push不仅在测试环境需要pull代码，
可能还有nginx，uwsgi，supervisor等都需要重启。那么有没有什么办法让你在push代码的时候触发这一系列的重新部署呢？</p>

<h4 id="section-1">思路和例子</h4>

<p>假设你的开发分支是feature_example_develop(你要是在master分支直接push也可以，呵呵)有A，B，C等等同事都会往这个分支提交东西
测试环境的IP为192.168.22.34</p>

<ol>
  <li>在你的git版本库的hooks里面这些修改post-update(表示代码提交到版本库后触发)</li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">#!/bin/sh
</span><span class="line">#
</span><span class="line"># An example hook script to prepare a packed repository for use over
</span><span class="line"># dumb transports.
</span><span class="line">#
</span><span class="line"># To enable this hook, rename this file to "post-update".
</span><span class="line">
</span><span class="line"># 获取本次提交的分支名字
</span><span class="line">branch=$(git rev-parse --symbolic --abbrev-ref $1)
</span><span class="line">        
</span><span class="line">case "$branch" in
</span><span class="line">    feature_example_develop)
</span><span class="line">        echo This is a develop push
</span><span class="line">        # 远程执行测试环境下的sync_develop_code.sh脚本
</span><span class="line">        ssh dongwm@192.168.22.34  -p 9922 "source sync_develop_code.sh"
</span><span class="line">        ;;
</span><span class="line">    master)
</span><span class="line">        echo This is a master push
</span><span class="line">        ;;
</span><span class="line">    *)
</span><span class="line">        echo This is only some push ops.
</span><span class="line">        ;;
</span><span class="line">esac
</span><span class="line">
</span><span class="line">exec git update-server-info</span></pre></figure></notextile></div>

<ol>
  <li>测试环境的更新环境脚本 sync_develop_code.sh</li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">#! /bin/bash
</span><span class="line"># 切换到git版本库目录下
</span><span class="line">cd /home/dongwm/test_develop
</span><span class="line"># '拉'下最新代码
</span><span class="line">git pull origin feature_example_develop
</span><span class="line"># 重启supervisor管理的进程
</span><span class="line">sudo supervisorctl -c /home/dongwm/test_develop/server/supervisor_develop.conf restart all
</span><span class="line"># 重启uwsgi
</span><span class="line">sudo /etc/init.d/uwsgi restart</span></pre></figure></notextile></div>

<h4 id="section-2">一个很重要的问题</h4>

<p>post-update不会检查你的代码是不是有问题，当提交了错误的代码会造成测试环境问题
解决办法：修改update钩子-在提交前对你设置的操作的执行的$?做判断-非0就会拒绝你的提交，在这个时候你可以做pylint/coverage/nosetests等，下次我再说我做的这个工作</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/gei-chu-xue-pythonshe-ji-mo-shi-de-pythonista/">给初学python设计模式的pythonista</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-17T22:16:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4 id="section">前言</h4>

<p>从2011年5月4日买了第一本《python学习手册》到现在，我学python已经2年多了，python也是我第一门除bash外的语言。
学’设计模式’这么神秘的东西还是源于去年一次面试，在我说了我想做某个东西，然后有什么思路后，面试官很不屑的问我：你知道设计模式嘛？
然后我就懵了-从来没听过。我特别赞赏提供良好扩展功能的项目，比如<a href="http://www.sublimetext.com/2">Sublime Text2</a>, 它提供第三方插件功能，你可以使用别人开发的插件，也可以自己写插件，让项目更好的维护和扩展而不需要动基础的代码。
后来换工作一直在熟悉业务，学一些东西。但是我一直记得这个’设计模式’，上个月花了一些时间去了解，所以有了此文，假如你也想了解’设计模式’,也很怕它，你会python，希望本文带给你帮助</p>

<p>我也写了一组python设计模式的文章: <a href="http://dongweiming.github.io/category/she-ji-mo-shi.html">小明明s Github - 设计模式</a></p>

<h4 id="section-1">我的角度</h4>

<p>GoF（“四人帮”，又称Gang of Four，即Erich Gamma, Richard Helm, Ralph Johnson &amp; John Vlissides四人）的《设计模式》这本书我没看过，我也不怎么会java，看不懂例子.我没有受到其他语言的毒害(因为python是我一开始的语言)，我的角度应该是最靠近python</p>

<h4 id="section-2">什么是设计模式</h4>

<p>设计模式其实是一些被很多人反复使用而总结出来的代码设计经验，这些技术被GOF在大概20年前编辑成《编程模式》，其实不要害怕，
因为<strong>设计模式就在你写代码过程中已经体现了，被叫做’设计模式’只是被很好的总结出来</strong>，</p>

<h4 id="python">python程序员的成长</h4>

<ul>
  <li>
    <p>当你初学python，可能还是翻阅手册或者去google出一些你想要问题的答案，而后举一反三修改它符合你想要的东西。那么这是阶段一：堆代码，这个时候主要是为了实现功能，不重视代码编码规范，代码运行效率，代码可读性等</p>
  </li>
  <li>
    <p>用过一段时间python，你对python很熟悉了，可以copy代码写东西了。那么这是阶段二：码农初长成</p>
  </li>
  <li>
    <p>我是这样的人：当一个类似的功能出现，我就想思考重构(重构这个词太大了，好吧，为了减少我的代码量);当经常出现某些相同的情况的过程，我就会思考更好的抽象出来;当项目大了，、
会思考如何在不改动或者少改动的前提下更好的扩展新功能。那么这是阶段三: 码农中的愤青 这里你会对自己有更高的要求，其实总结一些更好的表达和实现，就是设计模式了</p>
  </li>
  <li>
    <p>埋头写代码毕竟进步有限，这个时候可能你会读一些好的开源代码，保存了很多别人的代码片段等，你会发现:哦，原来可以这么写.. 哇 这个实现好酷… 然后你会记下来，
等以后在合适的场景里面借用这些思想, 这是阶段四：在很多开源代码中会看见一些很好的设计模式的体现，就是这样看别人，然后理解吸收</p>
  </li>
</ul>

<h4 id="python-1">如何学习python的设计模式</h4>

<p>github上面有2个这方面的项目: <a href="https://github.com/faif/python-patterns">python-patterns</a>和<a href="https://github.com/gennad/Design-Patterns-in-Python">Design-Patterns-in-Python</a>, 但是都不怎么维护了
当然了，做广告,可以看我的GithubPages<a href="http://dongweiming.github.io/category/she-ji-mo-shi.html">小明明s Github - 设计模式</a>,都是我自己的理解，欢迎大家提意见</p>

<h4 id="python-2">python的设计模式</h4>

<p>通过我学习和写这些模式的文章，我有很多感悟</p>

<ul>
  <li>
    <p>对于python，装饰器模式其实都已经是内置代码级别;</p>
  </li>
  <li>
    <p><a href="http://dongweiming.github.io/python-flyweight.html">flyweight模式</a>原来还可以这样玩;</p>
  </li>
  <li>
    <p><a href="http://dongweiming.github.io/python-singleton.html">单例模式</a>已经落伍，完全可以被<a href="http://dongweiming.github.io/python-borg.html">borg模式</a>取代</p>
  </li>
  <li>
    <p><a href="http://dongweiming.github.io/python-null.html">NUll模式</a>可以帮助你省去很多代码和异常处理</p>
  </li>
  <li>
    <p><a href="http://dongweiming.github.io/python-object-pool.html">对象池模式</a>是一个很实用的模式</p>
  </li>
  <li>
    <p>终于理解游戏人物设计用到了<a href="http://dongweiming.github.io/python-pototype.html">原型模式</a></p>
  </li>
</ul>

<p>…</p>

<p>基本是学了每个模式都有很深的触动</p>

<h4 id="section-3">学习设计模式有没有必要</h4>

<p>没有学习设计模式不会影响你写代码的水平，但是学习了会提高你的代码质量和拓宽你解决问题的思路</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/wo-wei-hu-de-colout/">我维护的colout</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-07T23:14:00+08:00" pubdate data-updated="true">Jun 7<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4 id="section">前言</h4>

<p>一直在努力进步，其实也在想做点项目，也作了一些东西，最近的计划就是看<a href="https://github.com/celery/celery">celery</a>,<a href="https://github.com/getpelican/pelican">pelican</a>,然后开始看django，看<a href="https://github.com/kennethreitz/requests">requests</a>, 其实任务还是很重的。
上段时间github转悠，发现一个挺有意思的东西<a href="https://github.com/nojhan/colout">colout</a>：一个python的命令行显示彩色字符的软件，支持正则，支持各种语法的插件，但是作者呢..怎么说呢 也算是我为了练手,给他维护这个项目,</p>

<h4 id="section-1">我维护的内容</h4>

<p>正如我给它修改的README</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">Pypi(the Python Package Index)
</span><span class="line">
</span><span class="line">    sudo pip install colout
</span><span class="line">
</span><span class="line">or
</span><span class="line">
</span><span class="line">    sudo easy_install colout
</span><span class="line">
</span><span class="line">Ubuntu 13.04's ppa
</span><span class="line">
</span><span class="line">    sudo add-apt-repository ppa:ciici123/colout
</span><span class="line">    sudo apt-get update
</span><span class="line">    sudo apt-get/aptitude install colout
</span><span class="line">
</span><span class="line">Gentoo overlay
</span><span class="line">
</span><span class="line">    1. Install layman
</span><span class="line">    
</span><span class="line">    echo "app-portage/layman git" &gt;&gt; $EPREFIX/etc/portage/package.Use
</span><span class="line">    sudo emerge layman
</span><span class="line">    
</span><span class="line">    2. Edit `$EPREFIX/etc/layman/layman.cfg`. Add a line after
</span><span class="line">    
</span><span class="line">    overlays   : http://www.gentoo.org/proj/en/overlays/repositories.xml
</span><span class="line">    
</span><span class="line">    so that it becomes
</span><span class="line">    
</span><span class="line">    overlays   : http://www.gentoo.org/proj/en/overlays/repositories.xml
</span><span class="line">                 file://$EPREFIX/var/lib/layman/my-list.xml
</span><span class="line">
</span><span class="line">    3. Edit `$EPREFIX/var/lib/layman/my-list.xml`.  The content of this file should be:
</span><span class="line">    
</span><span class="line">    &lt;?xml version="1.0" ?&gt;
</span><span class="line">    &lt;repositories version="1.0"&gt;
</span><span class="line">    &lt;repo priority="50" quality="experimental" status="unofficial"&gt;
</span><span class="line">        &lt;name&gt;dongwm-overlay&lt;/name&gt;
</span><span class="line">        &lt;description&gt;dongweiming's gentoo overlay&lt;/description&gt;
</span><span class="line">        &lt;homepage&gt;https://github.com/dongweiming/dongwm-overlay.git&lt;/homepage&gt;
</span><span class="line">        &lt;owner&gt;
</span><span class="line">            &lt;email&gt;ciici1234@hotmail.com&lt;/email&gt;
</span><span class="line">        &lt;/owner&gt;
</span><span class="line">        &lt;source type="git"&gt;git://github.com/dongweiming/dongwm-overlay.git&lt;/source&gt;
</span><span class="line">    &lt;/repo&gt;
</span><span class="line">    &lt;/repositories&gt;
</span><span class="line">
</span><span class="line">    4. Add this overlay and installation
</span><span class="line">    
</span><span class="line">    layman -a dongwm-overlay &amp;&amp; sudo emerge colout</span></pre></figure></notextile></div>

<p>其实现在已经放到了gentoo的portage主干，你可以直接安装</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">sudo emerge colout</span></pre></figure></notextile></div>

<h4 id="pypiubuntus-ppagentoo">也就是说我维护了pypi，ubuntu’s ppa和gentoo</h4>

<p>这个经验讲起来，很多很多，时间有点长了…</p>

<ul>
  <li>pypi</li>
</ul>

<p>我这部分源码是从作者项目拿下来的分支<a href="https://github.com/dongweiming/colout">colout</a>, 里面加了一些必要的东西，还有setup.py的格式
其中的’classifiers’是从官网文档分析的<a href="https://pypi.python.org/pypi?:action=list_classifiers">classifiers</a>, 而且要注意的是,根据
最近的<a href="http://www.python.org/dev/peps/pep-0438/">PEP438</a>, 以后的pypi不要容许来自外部软件的网站连接，直接使用pypi的地址已加快速度</p>

<h5 id="section-2">流程</h5>

<ol>
  <li>注册pypi,你可以去网站 也可以python setup.py register</li>
  <li>添加相关文件和setup.py</li>
  <li>python setup.py sdist upload  #上传到pypi</li>
</ol>

<p>技巧:</p>

<p>你可以写.pypirc配置文件就不用每次输入帐号密码了</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">[distutils]
</span><span class="line">index-servers = pypi
</span><span class="line">
</span><span class="line">[pypi]
</span><span class="line">username:xxx
</span><span class="line">password:xxx</span></pre></figure></notextile></div>

<p>表示构建dist包后并且上传，当然你还能再加’bdist_egg’ 构建eggs</p>

<ul>
  <li>gentoo 本来就是我的一个layman,但是看来gentoo的开发者也挺喜欢这个小玩意，后来把它放在了主干</li>
</ul>

<p>流程:</p>

<ol>
  <li>写ebuild脚本 请参看我的<a href="https://github.com/dongweiming/dongwm-overlay">overlay for Gentoo</a></li>
  <li>假如你想用第三方的overlay，上面README有安装方法，假如你想放到gentoo主干，继续…</li>
  <li>建立一个Bugzilla帐号</li>
  <li>创建一个bug，填写表单，附件加入你写的那个ebuild脚本，看我的例子<a href="https://bugs.gentoo.org/show_bug.cgi?id=469562">app-misc/colout - a simple command to add colors to a text stream in your terminal</a></li>
</ol>

<p>技巧:</p>

<ul>
  <li>ubuntu ppa 是最闹残，最无奈的，源文件在我虚拟机里面，有时间我再补</li>
</ul>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/shi-yong-pelicanxin-de/">使用pelican心得</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-06T23:32:00+08:00" pubdate data-updated="true">Jun 6<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4 id="section">前言</h4>

<p>最近在用<a href="http://getpelican.com/">pelican</a>借用<a href="http://pages.github.com">GitHub Pages</a>搭建我的<a href="http://dongweiming.github.io">小明明s Github</a>, 总结了些心得</p>

<h4 id="makefile">写好Makefile</h4>

<p>ruby有rake，但是python的好像没什么好用的，还是用Makefile，简单粗暴.先看用的</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">help:                                       
</span><span class="line">    @echo 'Makefile for a pelican Web site                                        '
</span><span class="line">    @echo '                                                                       '
</span><span class="line">    @echo 'Usage:                                                                 '
</span><span class="line">    @echo '   make html                        (re)generate the web site          '
</span><span class="line">    @echo '   make clean                       remove the generated files         '
</span><span class="line">                                                              
</span><span class="line">local:                                                           
</span><span class="line">    ./regen -q                                                  
</span><span class="line">github:-                                                       
</span><span class="line">    ./regen                                                   
</span><span class="line">    ghp-import -b master $(OUTPUTDIR)                        
</span><span class="line">    git push origin gh-pages:gh-pages-                      
</span><span class="line">    git push origin master:master                          
</span><span class="line">                                                          
</span><span class="line">.PHONY: help github local 
</span></pre></figure></notextile></div>

<p>其中的regen是封装的脚本, 主要是为了加参数让我在本地生成html(其中的文件连接都指到我本地),然后我用python -m SimpleHTTPServer启动:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">#!/usr/bin/env bash
</span><span class="line">
</span><span class="line">set -e
</span><span class="line">
</span><span class="line">quiet=""
</span><span class="line">output="output"
</span><span class="line">if [ "$1" = "-q" ] ; then
</span><span class="line">    shift
</span><span class="line">    quiet="1"
</span><span class="line">    output="output-local"
</span><span class="line">    export OVERRIDE_SITEURL=http://localhost:8000
</span><span class="line">fi
</span><span class="line">
</span><span class="line">echo -n "regenerating..."
</span><span class="line">pelican content/ -o $output -s pelicanconf.py "$@"
</span><span class="line">echo done.
</span></pre></figure></notextile></div>

<h4 id="github">我提交到github的方式</h4>

<p>上面的脚本已经很明显了，我直接执行make github</p>

<p>其中的<a href="http://github.com/davisp/ghp-import">ghp-import</a>的介绍很明显了:Easily import docs to your gh-pages branch</p>

<p>但是有个大坑: githubpages是要从你的项目的master分支去获取html页面，而不是gh-pages分支,所以Makefile我修改了下用法</p>

<h4 id="push">自动push不需要帐号密码</h4>

<p>其实就是添加~./netrc</p>

<p>machine github.com
login XXX@gmail.com
password XXX</p>

<h4 id="section-1">可配置的创建文章</h4>

<p>想想octopress的Rakefile，里面定义了一个new_post的方法，额pelican什么都没有，好吧，我用shell做了个</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">#!/bin/bash
</span><span class="line">category='设计模式'
</span><span class="line">title_resource='python设计模式之'
</span><span class="line">tags='Design Patterns'
</span><span class="line">
</span><span class="line">while getopts ":c:r:g:s:t:" opt; do
</span><span class="line">  case $opt in
</span><span class="line">    c)
</span><span class="line">    category=$OPTARG
</span><span class="line">      ;;
</span><span class="line">    r)
</span><span class="line">    title_resource=$OPTARG
</span><span class="line">        ;;
</span><span class="line">    g)
</span><span class="line">    tags=$OPTARG
</span><span class="line">        ;;
</span><span class="line">    t)
</span><span class="line">    title=$OPTARG
</span><span class="line">        ;;
</span><span class="line">    s)
</span><span class="line">    slug=$PTARG
</span><span class="line">        ;;
</span><span class="line">    ?)
</span><span class="line">      echo "How to use: $0 [-c category] [-r title_resource] [-g tags] [-t title] [-s slug]" &gt;&amp;2
</span><span class="line">      exit 1
</span><span class="line">      ;;
</span><span class="line">    :)
</span><span class="line">      echo "Option -$OPTARG requires an argument." &gt;&amp;2
</span><span class="line">      exit 1
</span><span class="line">      ;;
</span><span class="line">  esac
</span><span class="line">done
</span><span class="line">test "x$title" = "x" &amp;&amp; read -r -p "Post title [前缀是 ${title_resource}]&gt; " &amp;&amp; title=${REPLY}
</span><span class="line">test "x$slug" = "x" &amp;&amp; read -r -p "Post slug [比如abstract-factory]&gt; " &amp;&amp; slug=${REPLY}
</span><span class="line">title=`echo $title | tr "[:upper:]" "[:lower:]"]`
</span><span class="line">title=`echo $title | tr -d "[:blank:]"`
</span><span class="line">slug=`echo $slug | tr " " "-"`
</span><span class="line">fileslug=`echo $slug | tr "-" '_'`
</span><span class="line">cur_date=`date "+%Y-%m-%d"`
</span><span class="line">filename="${category}/${fileslug}.md"
</span><span class="line">author=`git config --get user.name`
</span><span class="line">echo "Creating preview"
</span><span class="line">echo "_________________________________"
</span><span class="line">echo "filename: content/$filename"
</span><span class="line">echo "title: ${title_resource}${title}"
</span><span class="line">echo "slug: python-${slug}"
</span><span class="line">echo "date: ${cur_date}"
</span><span class="line">echo "category: ${category}"
</span><span class="line">echo "tags: ${tags}"
</span><span class="line">echo "_________________________________"
</span><span class="line">echo ""
</span><span class="line">read -r -p "Are you ready to create(Y or N) &gt;"
</span><span class="line">reply=${REPLY}
</span><span class="line">reply=`echo $reply | tr "[:upper:]" "[:lower:]"]`
</span><span class="line">test "x$reply" != "xy" &amp;&amp; exit 1
</span><span class="line">cat &gt; "content/"$filename &lt;&lt;EOF
</span><span class="line">title: ${title_resource}${title}
</span><span class="line">slug: python-${slug}
</span><span class="line">date: ${cur_date}
</span><span class="line">category: ${category}
</span><span class="line">tags: ${tags}
</span><span class="line">
</span><span class="line">EOF
</span><span class="line">
</span><span class="line">$EDITOR "content/"$filename
</span></pre></figure></notextile></div>

<h4 id="psdongweiminggithubiohttpsgithubcomdongweimingdongweiminggithubiogh-pages">PS：以上脚本都可以到我的项目<a href="https://github.com/dongweiming/dongweiming.github.io">dongweiming.github.io</a>的gh-pages分支去拿</h4>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/duo-master-slash-developfen-zhi-shi-yong-gitflow/">多master/develop分支使用gitflow</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-04T20:30:00+08:00" pubdate data-updated="true">Jun 4<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4 id="section"><em>前言</em></h4>

<p>公司都是git作为版本控制，公司一些项目组在用gitflow，但是我们组没有强制，
但是我上月出了一次事故，总结就是分支管理问题，所以开始强迫自己使用gitflow,
以前的项目是一个master和一个develop，自己checkout一个分支，然后merge(不理解的可以看看<a href="http://nvie.com/posts/a-successful-git-branching-model/">a-successful-git-branching-model</a>).</p>

<p>问题出现了: 项目有几个主分支和开发分支，比如master_sina, master_qq. master_buzz ,而gitflow的时候只能指定一个master/develop, 这样你start一个feature/hotfix之前就要去.git/config里面修改
[gitflow “branch”]项的相关主分支和开发分支，so不方便。看了下源码，给gitflow加点料</p>

<h4 id="section-1">添加功能</h4>

<ul>
  <li>当你打开了feature/hotfix分支，但是你不想要它了(当然你可以直接git branch -D xx)，使用git flow hotfix/feature delete ,自动帮你删除这个分支，以便你新建其他分支(git flow只容许你一次存在一个hotfix/feature分支)</li>
  <li>你想使用gitflow删除其它存在分支嘛？不需要 git branch -D ，你还可以git flow hotfix/feature delete XX </li>
  <li>比如我在init的时候指定了master为master_sina,  而当我想创建master_qq的hotfix，我只需要在start的是否给它取名字是’qq_‘开头的即可，要是有其它的需要你可以直接在源码里面添加对应的内容</li>
</ul>

<h4 id="git-flow-hotfix--">例子 git-flow-hotfix  我主要标记我修改的部分</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">init() {
</span><span class="line">  require_git_repo
</span><span class="line">  require_gitflow_initialized
</span><span class="line">  gitflow_load_settings
</span><span class="line">  VERSION_PREFIX=$(eval "echo `git config --get gitflow.prefix.versiontag`")
</span><span class="line">  PREFIX=$(git config --get gitflow.prefix.hotfix)
</span><span class="line">}
</span><span class="line"># 增加help的选项说明
</span><span class="line">usage() {
</span><span class="line">    echo "usage: git flow hotfix [list] [-v]"
</span><span class="line">    echo "       git flow hotfix start [-F] &lt;version&gt; [&lt;base&gt;]"
</span><span class="line">    echo "       git flow hotfix finish [-Fsumpk] &lt;version&gt;"
</span><span class="line">    echo "       git flow hotfix publish &lt;version&gt;"
</span><span class="line">    echo "       git flow hotfix delete [branch]"
</span><span class="line">    echo "       git flow hotfix track &lt;version&gt;"
</span><span class="line">}
</span><span class="line">cmd_default() {
</span><span class="line">    cmd_list "$@"
</span><span class="line">}
</span><span class="line">
</span><span class="line">cmd_list() {
</span><span class="line">    DEFINE_boolean verbose false 'verbose (more) output' v
</span><span class="line">    parse_args "$@"
</span><span class="line">
</span><span class="line">    local hotfix_branches
</span><span class="line">    local current_branch
</span><span class="line">    local short_names
</span><span class="line">    hotfix_branches=$(echo "$(git_local_branches)" | grep "^$PREFIX")
</span><span class="line">    if [ -z "$hotfix_branches" ]; then
</span><span class="line">        warn "No hotfix branches exist."
</span><span class="line">                warn ""
</span><span class="line">                warn "You can start a new hotfix branch:"
</span><span class="line">                warn ""
</span><span class="line">                warn "    git flow hotfix start &lt;version&gt; [&lt;base&gt;]"
</span><span class="line">                warn ""
</span><span class="line">        exit 0
</span><span class="line">    fi
</span><span class="line">    current_branch=$(git branch --no-color | grep '^\* ' | grep -v 'no branch' | sed 's/^* //g')
</span><span class="line">    short_names=$(echo "$hotfix_branches" | sed "s ^$PREFIX  g")
</span><span class="line">
</span><span class="line">    # determine column width first
</span><span class="line">    local width=0
</span><span class="line">    local branch
</span><span class="line">    for branch in $short_names; do
</span><span class="line">        local len=${#branch}
</span><span class="line">        width=$(max $width $len)
</span><span class="line">    done
</span><span class="line">    width=$(($width+3))
</span><span class="line">
</span><span class="line">    local branch
</span><span class="line">    for branch in $short_names; do
</span><span class="line">        local fullname=$PREFIX$branch
</span><span class="line">        local base=$(git merge-base "$fullname" "$MASTER_BRANCH")
</span><span class="line">        local master_sha=$(git rev-parse "$MASTER_BRANCH")
</span><span class="line">        local branch_sha=$(git rev-parse "$fullname")
</span><span class="line">        if [ "$fullname" = "$current_branch" ]; then
</span><span class="line">            printf "* "
</span><span class="line">        else
</span><span class="line">            printf "  "
</span><span class="line">        fi
</span><span class="line">        if flag verbose; then
</span><span class="line">            printf "%-${width}s" "$branch"
</span><span class="line">            if [ "$branch_sha" = "$master_sha" ]; then
</span><span class="line">                printf "(no commits yet)"
</span><span class="line">            else
</span><span class="line">                local tagname=$(git name-rev --tags --no-undefined --name-only "$base")
</span><span class="line">                local nicename
</span><span class="line">                if [ "$tagname" != "" ]; then
</span><span class="line">                    nicename=$tagname
</span><span class="line">                else
</span><span class="line">                    nicename=$(git rev-parse --short "$base")
</span><span class="line">                fi
</span><span class="line">                printf "(based on $nicename)"
</span><span class="line">            fi
</span><span class="line">        else
</span><span class="line">            printf "%s" "$branch"
</span><span class="line">        fi
</span><span class="line">        echo
</span><span class="line">    done
</span><span class="line">}
</span><span class="line">
</span><span class="line">cmd_help() {
</span><span class="line">    usage
</span><span class="line">    exit 0
</span><span class="line">}
</span><span class="line">
</span><span class="line">parse_args() {
</span><span class="line">    # parse options
</span><span class="line">    FLAGS "$@" || exit $?
</span><span class="line">    eval set -- "${FLAGS_ARGV}"
</span><span class="line">    # read arguments into global variables
</span><span class="line">    VERSION=$1
</span><span class="line">    BRANCH=$PREFIX$VERSION
</span><span class="line">    # 这里就是我多master/develop的技巧，我这里会判断要新建的分支的前缀，
</span><span class="line">    # 要是qq_开头就会基于master_qq和develop_qq创建分支。所以你可以根据你的需要在这里加一些方法
</span><span class="line">    test `expr match "$@" "qq_"` -ne 0 &amp;&amp; MASTER_BRANCH="$MASTER_BRANCH"_qq &amp;&amp;
</span><span class="line">    DEVELOP_BRANCH="$DEVELOP_BRANCH"_qq
</span><span class="line">}
</span><span class="line">
</span><span class="line">require_version_arg() {
</span><span class="line">    if [ "$VERSION" = "" ]; then
</span><span class="line">        warn "Missing argument &lt;version&gt;"
</span><span class="line">        usage
</span><span class="line">        exit 1
</span><span class="line">    fi
</span><span class="line">}
</span><span class="line">
</span><span class="line">require_base_is_on_master() {
</span><span class="line">    if ! git branch --no-color --contains "$BASE" 2&gt;/dev/null \
</span><span class="line">            | sed 's/[* ] //g' \
</span><span class="line">            | grep -q "^$MASTER_BRANCH\$"; then
</span><span class="line">        die "fatal: Given base '$BASE' is not a valid commit on '$MASTER_BRANCH'."
</span><span class="line">    fi
</span><span class="line">}
</span><span class="line">
</span><span class="line">require_no_existing_hotfix_branches() {
</span><span class="line">    local hotfix_branches=$(echo "$(git_local_branches)" | grep "^$PREFIX")
</span><span class="line">    local first_branch=$(echo ${hotfix_branches} | head -n1)
</span><span class="line">    first_branch=${first_branch#$PREFIX}
</span><span class="line">    [ -z "$hotfix_branches" ] || \
</span><span class="line">        die "There is an existing hotfix branch ($first_branch). Finish that one first."
</span><span class="line">}
</span><span class="line"># 添加delete 参数，函数需要cmd_开头
</span><span class="line">cmd_delete() {
</span><span class="line">    if [ "$1" = "" ]; then
</span><span class="line">        # 当不指定参数自动去找存在的未关闭的gitflow分支
</span><span class="line">        local hotfix_branches=$(echo "$(git_local_branches)" | grep "^$PREFIX")
</span><span class="line">        test "$hotfix_branches" = "" &amp;&amp; die "There has not existing hotfix branch can delete" &amp;&amp; exit 1
</span><span class="line">    else
</span><span class="line">        # 指定参数先判断参数是不是的数量格式
</span><span class="line">        test $# != 1 &amp;&amp; die "There only need one parameter indicates the branch to be deleted" &amp;&amp; exit 1
</span><span class="line">        hotfix_branches="$1"
</span><span class="line">    fi
</span><span class="line">    # 当要删除的分支就是当前分支，先checkout到develop分支
</span><span class="line">    test "$hotfix_branches" = "$(git_current_branch)" &amp;&amp; echo 'First checkout develp branch'; git_do checkout "$DEVELOP_BRANCH"
</span><span class="line">    git branch -D  ${hotfix_branches} &gt; /dev/null 2&gt;&amp;1&amp;&amp; echo 'Delete Successed'|| die "Did not find branch: [$hotfix_branches]"
</span><span class="line">
</span><span class="line">}
</span><span class="line">cmd_start() {
</span><span class="line">    DEFINE_boolean fetch false "fetch from $ORIGIN before performing finish" F
</span><span class="line">    parse_args "$@"
</span><span class="line">    BASE=${2:-$MASTER_BRANCH}
</span><span class="line">    require_version_arg
</span><span class="line">    require_base_is_on_master
</span><span class="line">    require_no_existing_hotfix_branches
</span><span class="line">
</span><span class="line">    # sanity checks
</span><span class="line">    require_clean_working_tree
</span><span class="line">    require_branch_absent "$BRANCH"
</span><span class="line">    require_tag_absent "$VERSION_PREFIX$VERSION"
</span><span class="line">    if flag fetch; then
</span><span class="line">        git_do fetch -q "$ORIGIN" "$MASTER_BRANCH"
</span><span class="line">    fi
</span><span class="line">    if has "$ORIGIN/$MASTER_BRANCH" $(git_remote_branches); then
</span><span class="line">        require_branches_equal "$MASTER_BRANCH" "$ORIGIN/$MASTER_BRANCH"
</span><span class="line">    fi
</span><span class="line">
</span><span class="line">    # create branch
</span><span class="line">    git_do checkout -b "$BRANCH" "$BASE"
</span><span class="line">
</span><span class="line">    echo
</span><span class="line">    echo "Summary of actions:"
</span><span class="line">    echo "- A new branch '$BRANCH' was created, based on '$BASE'"
</span><span class="line">    echo "- You are now on branch '$BRANCH'"
</span><span class="line">    echo
</span><span class="line">    echo "Follow-up actions:"
</span><span class="line">    echo "- Bump the version number now!"
</span><span class="line">    echo "- Start committing your hot fixes"
</span><span class="line">    echo "- When done, run:"
</span><span class="line">    echo
</span><span class="line">    echo "     git flow hotfix finish '$VERSION'"
</span><span class="line">    echo
</span><span class="line">}
</span><span class="line">
</span><span class="line">cmd_publish() {
</span><span class="line">    parse_args "$@"
</span><span class="line">    require_version_arg
</span><span class="line">
</span><span class="line">    # sanity checks
</span><span class="line">    require_clean_working_tree
</span><span class="line">    require_branch "$BRANCH"
</span><span class="line">    git_do fetch -q "$ORIGIN"
</span><span class="line">    require_branch_absent "$ORIGIN/$BRANCH"
</span><span class="line">
</span><span class="line">    # create remote branch
</span><span class="line">    git_do push "$ORIGIN" "$BRANCH:refs/heads/$BRANCH"
</span><span class="line">    git_do fetch -q "$ORIGIN"
</span><span class="line">
</span><span class="line">    # configure remote tracking
</span><span class="line">    git config "branch.$BRANCH.remote" "$ORIGIN"
</span><span class="line">    git config "branch.$BRANCH.merge" "refs/heads/$BRANCH"
</span><span class="line">    git_do checkout "$BRANCH"
</span><span class="line">
</span><span class="line">    echo
</span><span class="line">    echo "Summary of actions:"
</span><span class="line">    echo "- A new remote branch '$BRANCH' was created"
</span><span class="line">    echo "- The local branch '$BRANCH' was configured to track the remote branch"
</span><span class="line">    echo "- You are now on branch '$BRANCH'"
</span><span class="line">    echo
</span><span class="line">}
</span><span class="line">
</span><span class="line">cmd_track() {
</span><span class="line">    parse_args "$@"
</span><span class="line">    require_version_arg
</span><span class="line">
</span><span class="line">    # sanity checks
</span><span class="line">    require_clean_working_tree
</span><span class="line">    require_branch_absent "$BRANCH"
</span><span class="line">    git_do fetch -q "$ORIGIN"
</span><span class="line">    require_branch "$ORIGIN/$BRANCH"
</span><span class="line">
</span><span class="line">    # create tracking branch
</span><span class="line">    git_do checkout -b "$BRANCH" "$ORIGIN/$BRANCH"
</span><span class="line">
</span><span class="line">    echo
</span><span class="line">    echo "Summary of actions:"
</span><span class="line">    echo "- A new remote tracking branch '$BRANCH' was created"
</span><span class="line">    echo "- You are now on branch '$BRANCH'"
</span><span class="line">    echo
</span><span class="line">}
</span><span class="line">
</span><span class="line">cmd_finish() {
</span><span class="line">    DEFINE_boolean fetch false "fetch from $ORIGIN before performing finish" F
</span><span class="line">    DEFINE_boolean sign false "sign the release tag cryptographically" s
</span><span class="line">    DEFINE_string signingkey "" "use the given GPG-key for the digital signature (implies -s)" u
</span><span class="line">    DEFINE_string message "" "use the given tag message" m
</span><span class="line">    DEFINE_string messagefile "" "use the contents of the given file as tag message" f
</span><span class="line">    DEFINE_boolean push false "push to $ORIGIN after performing finish" p
</span><span class="line">    DEFINE_boolean keep false "keep branch after performing finish" k
</span><span class="line">    DEFINE_boolean notag false "don't tag this release" n
</span><span class="line">    parse_args "$@"
</span><span class="line">    require_version_arg
</span><span class="line">
</span><span class="line">    # handle flags that imply other flags
</span><span class="line">    if [ "$FLAGS_signingkey" != "" ]; then
</span><span class="line">        FLAGS_sign=$FLAGS_TRUE
</span><span class="line">    fi
</span><span class="line">
</span><span class="line">    # sanity checks
</span><span class="line">    require_branch "$BRANCH"
</span><span class="line">    require_clean_working_tree
</span><span class="line">    if flag fetch; then
</span><span class="line">        git_do fetch -q "$ORIGIN" "$MASTER_BRANCH" || \
</span><span class="line">          die "Could not fetch $MASTER_BRANCH from $ORIGIN."
</span><span class="line">        git_do fetch -q "$ORIGIN" "$DEVELOP_BRANCH" || \
</span><span class="line">          die "Could not fetch $DEVELOP_BRANCH from $ORIGIN."
</span><span class="line">    fi
</span><span class="line">    if has "$ORIGIN/$MASTER_BRANCH" $(git_remote_branches); then
</span><span class="line">        require_branches_equal "$MASTER_BRANCH" "$ORIGIN/$MASTER_BRANCH"
</span><span class="line">    fi
</span><span class="line">    if has "$ORIGIN/$DEVELOP_BRANCH" $(git_remote_branches); then
</span><span class="line">        require_branches_equal "$DEVELOP_BRANCH" "$ORIGIN/$DEVELOP_BRANCH"
</span><span class="line">    fi
</span><span class="line">
</span><span class="line">    # try to merge into master
</span><span class="line">    # in case a previous attempt to finish this release branch has failed,
</span><span class="line">    # but the merge into master was successful, we skip it now
</span><span class="line">    if ! git_is_branch_merged_into "$BRANCH" "$MASTER_BRANCH"; then
</span><span class="line">        git_do checkout "$MASTER_BRANCH" || \
</span><span class="line">          die "Could not check out $MASTER_BRANCH."
</span><span class="line">        git_do merge --no-ff "$BRANCH" || \
</span><span class="line">          die "There were merge conflicts."
</span><span class="line">          # TODO: What do we do now?
</span><span class="line">    fi
</span><span class="line">
</span><span class="line">    if noflag notag; then
</span><span class="line">        # try to tag the release
</span><span class="line">        # in case a previous attempt to finish this release branch has failed,
</span><span class="line">        # but the tag was set successful, we skip it now
</span><span class="line">        local tagname=$VERSION_PREFIX$VERSION
</span><span class="line">        if ! git_tag_exists "$tagname"; then
</span><span class="line">            local opts="-a"
</span><span class="line">            flag sign &amp;&amp; opts="$opts -s"
</span><span class="line">            [ "$FLAGS_signingkey" != "" ] &amp;&amp; opts="$opts -u '$FLAGS_signingkey'"
</span><span class="line">            [ "$FLAGS_message" != "" ] &amp;&amp; opts="$opts -m '$FLAGS_message'"
</span><span class="line">            [ "$FLAGS_messagefile" != "" ] &amp;&amp; opts="$opts -F '$FLAGS_messagefile'"
</span><span class="line">            eval git_do tag $opts "$VERSION_PREFIX$VERSION" "$BRANCH" || \
</span><span class="line">            die "Tagging failed. Please run finish again to retry."
</span><span class="line">        fi
</span><span class="line">    fi
</span><span class="line">
</span><span class="line">    # try to merge into develop
</span><span class="line">    # in case a previous attempt to finish this release branch has failed,
</span><span class="line">    # but the merge into develop was successful, we skip it now
</span><span class="line">    if ! git_is_branch_merged_into "$BRANCH" "$DEVELOP_BRANCH"; then
</span><span class="line">        git_do checkout "$DEVELOP_BRANCH" || \
</span><span class="line">          die "Could not check out $DEVELOP_BRANCH."
</span><span class="line">
</span><span class="line">        # TODO: Actually, accounting for 'git describe' pays, so we should
</span><span class="line">        # ideally git merge --no-ff $tagname here, instead!
</span><span class="line">        git_do merge --no-ff "$BRANCH" || \
</span><span class="line">          die "There were merge conflicts."
</span><span class="line">          # TODO: What do we do now?
</span><span class="line">    fi
</span><span class="line">
</span><span class="line">    # delete branch
</span><span class="line">    if noflag keep; then
</span><span class="line">        # 这个问题很奇怪，在完成分支删除它也会存在当前分支是
</span><span class="line">        # 要删除的分支删除报错的问题，所以先切换走
</span><span class="line">        test "$BRANCH" = "$(git_current_branch)" &amp;&amp; git_do checkout "$DEVELOP_BRANCH"
</span><span class="line">        git_do branch -d "$BRANCH"
</span><span class="line">    fi
</span><span class="line">
</span><span class="line">    if flag push; then
</span><span class="line">        git_do push "$ORIGIN" "$DEVELOP_BRANCH" || \
</span><span class="line">            die "Could not push to $DEVELOP_BRANCH from $ORIGIN."
</span><span class="line">        git_do push "$ORIGIN" "$MASTER_BRANCH" || \
</span><span class="line">            die "Could not push to $MASTER_BRANCH from $ORIGIN."
</span><span class="line">        if noflag notag; then
</span><span class="line">            git_do push --tags "$ORIGIN" || \
</span><span class="line">                die "Could not push tags to $ORIGIN."
</span><span class="line">        fi
</span><span class="line">    fi
</span><span class="line">
</span><span class="line">    echo
</span><span class="line">    echo "Summary of actions:"
</span><span class="line">    echo "- Latest objects have been fetched from '$ORIGIN'"
</span><span class="line">    echo "- Hotfix branch has been merged into '$MASTER_BRANCH'"
</span><span class="line">    if noflag notag; then
</span><span class="line">        echo "- The hotfix was tagged '$VERSION_PREFIX$VERSION'"
</span><span class="line">    fi
</span><span class="line">    echo "- Hotfix branch has been back-merged into '$DEVELOP_BRANCH'"
</span><span class="line">    if flag keep; then
</span><span class="line">        echo "- Hotfix branch '$BRANCH' is still available"
</span><span class="line">    else
</span><span class="line">        echo "- Hotfix branch '$BRANCH' has been deleted"
</span><span class="line">    fi
</span><span class="line">    if flag push; then
</span><span class="line">        echo "- '$DEVELOP_BRANCH', '$MASTER_BRANCH' and tags have been pushed to '$ORIGIN'"
</span><span class="line">    fi
</span><span class="line">    echo
</span><span class="line">    }</span></pre></figure></notextile></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/a-web-based-reveal.js-online-PPT/">仿slid.es的在线PPT编辑网站</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-25T12:22:00+08:00" pubdate data-updated="true">May 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4 id="section">前言</h4>

<p><a href="https://slid.es">slid.es</a>是我最喜欢的前端之一<a href="https://github.com/hakimel">hakimel</a>的作品，前身叫做rvl.io, 网站已经改版。源于去年年底在上家公司做年终总结PPT，对我这种不搞office，没有美感的小程序员太痛苦了，然后就找到了<a href="https://github.com/hakimel/reveal.js">reveal.js</a>, 后来萌发做个基于它的网站, 其实也是为了练手学习mongoengine和oauth</p>

<p>项目地址 <a href="https://github.com/dongweiming/flask_reveal">flask_reveal</a></p>

<h4 id="section-1">它能做什么</h4>

<ul>
  <li>保存漂亮的在线PPT(我认为的)</li>
  <li>记录浏览次数</li>
  <li>多种主题和字体</li>
  <li>可以把PPT私有化(默认是公开的)</li>
  <li>自动保存修改</li>
  <li>支持Bitbucket/Google/Github/Instagram/Linkdln/Trello/Tumblr/Stackoverflow oauth/oauth2登陆</li>
  <li>PPT预览</li>
</ul>

<h4 id="section-2">使用了什么</h4>

<ul>
  <li>flask</li>
  <li>mongoengine (忍不了非orm)</li>
  <li>flask-script (像django那样的命令行启动)</li>
  <li>前端js借用我做喜欢的原作者的90%，然后根据我的需要改动，css基本没动</li>
  <li><a href="https://github.com/omab/python-social-auth">python-social-auth</a>的oauth后端，但是它使用的是flask+sqlalchemy，不支持flask+mongoengine，我改写了这部分</li>
</ul>

<h4 id="usage">Usage</h4>

<p>设置hosts文件</p>

<p>唉，本来申请了很多oauth想放在sae上面，但是遗憾的是新浪不支持，所以只能本地加hosts，让验证后的回调正确返回 linux 在你的/etc/hosts 文件里面添加一行</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">YOURIP   YOURDOMAIN</span></pre></figure></notextile></div>

<p>复制配置文件然后把你注册的ouauth放进去</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">cp settings.py.example settings.py</span></pre></figure></notextile></div>

<p>象django那样启动</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">python manage.py runserver -t 0.0.0.0 -p 80</span></pre></figure></notextile></div>

<p>And 访问主页<code>http://revealcn.sinaapp.com</code></p>

<h4 id="nginxuwsgi">使用nginx+uwsgi</h4>

<p>这里是我的配置nginx的这段（假设你git clone 后在/home/dongwm/flask_reveal）</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">server {
</span><span class="line">		listen 80;
</span><span class="line">		server_name revealcn.sinaapp.com;
</span><span class="line">
</span><span class="line">		access_log /var/log/nginx/revealcn.access_log main;
</span><span class="line">		error_log /var/log/nginx/revealcn.error_log info;
</span><span class="line">		location / {
</span><span class="line">                include uwsgi_params;
</span><span class="line">                uwsgi_pass unix:///tmp/uwsgi.sock;
</span><span class="line">        	}
</span><span class="line">		location /zongjie {
</span><span class="line">		root   /home/dongwm/flask_reveal;
</span><span class="line">		index index.html;
</span><span class="line">		}
</span><span class="line">	}
</span></pre></figure></notextile></div>

<p>uwsgi的xml配置</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">&lt;uwsgi&gt;
</span><span class="line">     &lt;pythonpath&gt;/home/dongwm/flask_reveal&lt;/pythonpath&gt;
</span><span class="line">     &lt;module&gt;manage&lt;/module&gt;
</span><span class="line">     &lt;socket&gt;/tmp/uwsgi.sock&lt;/socket&gt;    
</span><span class="line">    &lt;callable&gt;manager&lt;/callable&gt;
</span><span class="line">     &lt;master/&gt;
</span><span class="line">     &lt;processes&gt;4&lt;/processes&gt;       
</span><span class="line">     &lt;memory-report/&gt;
</span><span class="line">&lt;/uwsgi&gt;</span></pre></figure></notextile></div>

<p>这里有个坑，我的gentoo的uwsgi安装后是有插件的，你需要这样启动</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">uwsgi_python27 -x uwsgi.xml </span></pre></figure></notextile></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/how-to-not-exit-interactive-mode-autoreload/">怎样不退出交互模式自动reload模块</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-24T11:54:00+08:00" pubdate data-updated="true">May 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4 id="section"><em>前言</em></h4>

<p>我想做python开发的人尤其是django开发都会有一种经历:进入python交互模式(直接 执行python回车)或者进入django-shell调试某功能，然后修改源码，退出交互模式或者djangoshell，重新进入在吧那些模块一一import… 问题是什么呢？浪费时间，为啥不像web 框架那样修改源码自动reload？ </p>

<p>本来我花了2个多礼拜一直在做这件事情，其实原理就是封装ipython到我的shell，然后在我的shell加这个autoreload功能，但是昨晚看ipython源码发现：ipython早已经实现了…</p>

<p>我的系统的实现的源码文件是 /usr/lib64/python2.7/site-packages/IPython/Extensions/ipy_autoreload.py</p>

<h4 id="ipython">在ipython交互模式实现</h4>

<p>和ipython版本有关，大于0.11 这样加载</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">%load_ext autoreload
</span><span class="line">%autoreload 2</span></pre></figure></notextile></div>
<p>小于0.11的就要这样加载
&lt;div class=&#8217;bogus-wrapper&#8217;&gt;<notextile><figure class="code">&lt;pre class=&#8217;sh_&#8217;&gt;<span class="line">import ipy_autoreload
</span><span class="line">%autoreload 2</span>&lt;/pre&gt;</figure></notextile>&lt;/div&gt;</p>

<h4 id="ipython-1">ipython交互模式自动加载</h4>

<p>你总不像每次进入ipython都执行这么2句吧, 那么可以加到ipython的自定义配置里面.因操作系统和ipython版本不同，ipython的用户自定义目录有所不同，增加的配置也 有所不同</p>

<p>首先创建ipython个人配置 </p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">ipython profile create</span></pre></figure></notextile></div>

<p>gentoo ~/.ipython  ipython :0.10.2 </p>

<p>配置文件是.ipython/ipy_user_conf.py 添加</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">import ipy_autoreload
</span><span class="line">o.autoexec.append('%autoreload 2')
</span></pre></figure></notextile></div>

<p>opensuse ~/.config/ipython  :0.13</p>

<p>配置文件是~/.config/ipython/profile_default/ipython_config.py</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">c.InteractiveShellApp.exec_lines.append('%load_ext autoreload')
</span><span class="line">c.InteractiveShellApp.exec_lines.append('%autoreload 2')</span></pre></figure></notextile></div>

<h4 id="django-shell">Django shell的实现</h4>

<p>遗憾的是改django源码中的core/management/commands/shell.py,没有提供自动reload,但是当你修改了ipython配置 他也是会起作用(这个操作系统有关，下面我会说不起作用的geek方法)</p>

<p>PS： 你还可以使用<a href="https://github.com/dongweiming/django-extensions">django-extensions</a>中的shell_plus.py</p>

<h4 id="ipythonbpythonpythondjango-shell">当你系统有ipython,bpython和默认的python，django shell选择的顺序</h4>

<ul>
  <li>
    <p>当你系统没有ipython和bpython，那么就会选择默认的python</p>
  </li>
  <li>
    <p>上面说的shell_plus的遍历列表顺序是bpython-&gt;ipython  </p>
  </li>
  <li>
    <p>django自带的shell的遍历顺序是ipython-&gt;bpython</p>
  </li>
</ul>

<p>上面说djangoshell不起作用怎么办？首先看了django/ipython源码(0.13.2)，其实djangoshell甚至django-extensions里面的shell_plus都没有问题，关键是ipython的问题</p>

<p>我只说在用户配置里面的外部模块为啥没有正确执行</p>

<p>ipython进入交互模式的流程</p>

<ol>
  <li>当调用ipython，都是通过IPython.frontend.terminal.ipapp的launch_new_instance函数开始</li>
  <li>通过IPython.core.shellapp的InteractiveShellApp类里面的init_code方法去初始化启动后的加载</li>
  <li>在init_code方法会执行self._run_exec_lines(),这个就是上面的模块导入执行</li>
</ol>

<p>djangoshell进入交互模式的流程</p>

<ol>
  <li>通过IPython.frontend.terminal.embed的TerminalInteractiveShell类开始</li>
  <li>在TerminalInteractiveShell初始化中,没有执行上面的第三条</li>
</ol>

<p>解决办法就是暴力修改IPython/frontend/terminal/interactiveshell.py源码 给他加上模块初始化的操作</p>

<p>在326行开始的地方，这样添加一段(包含存在的代码帮你你理解在什么位置添加代码,也就是下面的3-8行)</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">self.init_usage(usage)                                                 
</span><span class="line">self.init_banner(banner1, banner2, display_banner) 
</span><span class="line">exex_lines = self.config['InteractiveShellApp']['exec_lines']          
</span><span class="line">for line in exex_lines:                                                
</span><span class="line">    try:                                                                        
</span><span class="line">        self.run_cell(line, store_history=False)                       
</span><span class="line">    except:                                                                     
</span><span class="line">        pass
</span><span class="line">#-------------------------------------------------------------------------          
</span><span class="line"># Overrides of init stages                                                          
</span><span class="line">#-------------------------------------------------------------------------</span></pre></figure></notextile></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/shi-yong-docopt-slash-schema-markdownwen-jian-zhi-jie-fa-song-you-jian/">使用docopt/schema:markdown文件直接发送支持python语法的邮件</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-13T17:42:00+08:00" pubdate data-updated="true">May 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2 id="section">前言</h2>

<ol>
  <li>工作经常写一些东西发邮件，但是渐渐的已经用markdown写东西，每次很纠结，</li>
  <li>而且还需要我打开邮箱，然后balabala，比如我还要在后面加入公司和自己的一些信息</li>
  <li>经常邮件或者html都带有python的源码段，想要一个支持python语法的css显示效果</li>
</ol>

<h2 id="section-1">使用的模块</h2>

<ul>
  <li><a href="https://github.com/docopt/docopt">docopt</a>  Pythonic的命令行函数解析，只需要把显示的参数列表放在__doc__</li>
  <li><a href="https://github.com/halst/schema">schema</a> Pythonic的数据结构验证，不需要那么多的异常处理</li>
  <li><a href="https://pypi.python.org/pypi/Markdown/2.3.1">markdown</a> </li>
  <li><a href="https://pypi.python.org/pypi/PyYAML/3.10">PyYAML</a>  解析yaml文件</li>
  <li><a href="https://pypi.python.org/pypi/Pygments/1.6">pygments</a> 借用它对python语法的一些正则匹配</li>
  <li><a href="https://github.com/kennethreitz/requests">requests</a> 我没有自己实现css，css可以本地自己自定义，也可以从网站下载，这里去爬网站的css文件</li>
</ul>

<p>PS:安装这些可以 </p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">sudo easy_install schema docopt markdown pygments pyyaml</span></pre></figure></notextile></div>

<h2 id="section-2">功能</h2>

<ul>
  <li>支持python语法</li>
  <li>支持本地有配置文件，不需要命令行balabala那么多(使用yaml)</li>
  <li>支持多种颜色方案，方案可选项: pygments-css</li>
  <li>支持本地自定义css(默认去这个网站爬回来)</li>
  <li>支持中文</li>
  <li>支持自定义html模板文件，比如我们公司邮件下部的联系方式等说明，可以放在模板邮件里面</li>
  <li>可以不发送邮件，只保留和加了css后的html到本地文件</li>
</ul>

<h2 id="section-3">使用举例</h2>

<ol>
  <li>默认模式</li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><pre class="sh_python"><span class="line"><span class="n">python</span> <span class="n">MarkPygments</span><span class="o">.</span><span class="n">py</span>  <span class="o">--</span><span class="n">mailto</span> <span class="n">mailto</span><span class="nd">@qq.com</span><span class="p">,</span><span class="n">mailto2</span><span class="nd">@qq.com</span>  <span class="o">-</span><span class="n">s</span> <span class="err">标题</span> <span class="o">--</span><span class="n">mailserver</span> <span class="n">smtp</span><span class="o">.</span><span class="n">exmail</span><span class="o">.</span><span class="n">qq</span><span class="o">.</span><span class="n">com</span> <span class="o">-</span><span class="n">u</span> <span class="n">youremailname</span>
</span><span class="line"><span class="o">-</span><span class="n">p</span> <span class="n">yourpassword</span>   <span class="o">--</span><span class="n">cc</span> <span class="n">cc</span><span class="nd">@qq.com</span> <span class="n">whatever</span><span class="o">.</span><span class="n">md</span> <span class="o">--</span><span class="n">template</span> <span class="n">template</span><span class="o">.</span><span class="n">html</span>
</span></pre></figure></notextile></div>

<ol>
  <li>使用本地yaml配置，配置如下, 配置中没有能命令行选项找，配置和终端都有会使用中有文件配置
这是yaml文件的内容：</li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><pre class="sh_python"><span class="line"><span class="n">markemail</span><span class="p">:</span>
</span><span class="line">    <span class="o">--</span><span class="n">theme</span><span class="p">:</span> <span class="n">autumn</span>
</span><span class="line">    <span class="o">--</span><span class="n">username</span><span class="p">:</span> <span class="n">XX</span>
</span><span class="line">    <span class="o">--</span><span class="n">password</span><span class="p">:</span> <span class="n">YY</span>
</span><span class="line">    <span class="o">--</span><span class="n">mailserver</span><span class="p">:</span> <span class="n">smtp</span><span class="o">.</span><span class="n">exmail</span><span class="o">.</span><span class="n">qq</span><span class="o">.</span><span class="n">com</span>
</span><span class="line">    <span class="o">--</span><span class="n">mailto</span><span class="p">:</span> <span class="n">to1</span><span class="nd">@qq.com</span><span class="p">,</span><span class="n">to2</span><span class="nd">@qq.com</span>
</span><span class="line">    <span class="o">--</span><span class="n">subject</span><span class="p">:</span> <span class="s">&#39;周报&#39;</span>
</span></pre></figure></notextile></div>

<p>然后这样使用：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><pre class="sh_python"><span class="line"><span class="n">python</span> <span class="n">MarkPygments</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">config</span> <span class="o">~/.</span><span class="n">config</span><span class="o">.</span><span class="n">yaml</span> <span class="n">whatever</span><span class="o">.</span><span class="n">md</span> <span class="o">--</span><span class="n">template</span> <span class="n">template</span><span class="o">.</span><span class="n">html</span>
</span></pre></figure></notextile></div>

<ol>
  <li>使用本地css目录下的css， 不发送邮件只保存html到本地文件</li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><pre class="sh_python"><span class="line"><span class="n">python</span> <span class="n">MarkPygments</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">config</span> <span class="o">~/.</span><span class="n">config</span><span class="o">.</span><span class="n">yaml</span> <span class="n">whatever</span><span class="o">.</span><span class="n">md</span> <span class="o">--</span><span class="n">template</span> <span class="n">template</span><span class="o">.</span><span class="n">html</span>
</span><span class="line"><span class="o">-</span><span class="n">o</span> <span class="n">out</span><span class="o">.</span><span class="n">html</span> <span class="o">--</span><span class="n">local</span> <span class="n">pygments</span><span class="o">-</span><span class="n">css</span>
</span></pre></figure></notextile></div>

<p>这里是代码，或者你可以去看<a href="https://github.com/orzrd/mytools/blob/master/MarkPygments.py">MarkPygments.py</a></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><pre class="sh_python"><span class="line"><span class="c"># coding=utf-8</span>
</span><span class="line"><span class="sd">&#39;&#39;&#39;</span>
</span><span class="line"><span class="sd">Usage:</span>
</span><span class="line"><span class="sd">MarkPygments.py [options] MDFILE</span>
</span><span class="line"><span class="sd">MarkPygments.py [options] --local &lt;cssdir&gt; MDFILE</span>
</span><span class="line"><span class="sd">MarkPygments.py [options] --config &lt;yamlfile&gt; MDFILE</span>
</span><span class="line">
</span><span class="line"><span class="sd">Arguments:</span>
</span><span class="line"><span class="sd">MDFILE the markdown file</span>
</span><span class="line"><span class="sd">-u --username user your email name</span>
</span><span class="line"><span class="sd">-p --password pass your email login password</span>
</span><span class="line"><span class="sd">-mt --mailto tolist mailto list</span>
</span><span class="line"><span class="sd">--theme theme css style for python syntax [default: monokai]</span>
</span><span class="line"><span class="sd">-s --subject subject email&#39;s subject</span>
</span><span class="line"><span class="sd">--mailserver server mail server [default: smtp.exmail.qq.com]</span>
</span><span class="line">
</span><span class="line"><span class="sd">Options:</span>
</span><span class="line"><span class="sd">-h --help show this help message and exit</span>
</span><span class="line"><span class="sd">--version show version and exit</span>
</span><span class="line"><span class="sd">--config yamlfile config yaml file path (e.g. .config.yaml)</span>
</span><span class="line"><span class="sd">--local cssdir use local custom css dir</span>
</span><span class="line"><span class="sd">-o --output [outhtml] make output to html file</span>
</span><span class="line"><span class="sd">-c --cc list cc list</span>
</span><span class="line"><span class="sd">--template html template html</span>
</span><span class="line">
</span><span class="line"><span class="sd">&#39;&#39;&#39;</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">os</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">re</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">codecs</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">smtplib</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">email.mime.multipart</span> <span class="kn">import</span> <span class="n">MIMEMultipart</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">markdown</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">docopt</span> <span class="kn">import</span> <span class="n">docopt</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">schema</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">And</span><span class="p">,</span> <span class="n">Or</span><span class="p">,</span> <span class="n">Use</span><span class="p">,</span> <span class="n">SchemaError</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;终端输出log&#39;&#39;&#39;</span>
</span><span class="line">    <span class="n">color</span> <span class="o">=</span> <span class="mi">31</span> <span class="k">if</span> <span class="n">error</span> <span class="k">else</span> <span class="mi">32</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\x1B</span><span class="s">[1;{0}m * {1}</span><span class="se">\x1B</span><span class="s">[0m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">regex</span><span class="p">():</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;借用pygments对python语法的实现以及自己实现的正则&#39;&#39;&#39;</span>
</span><span class="line">    <span class="kn">from</span> <span class="nn">pygments.lexers</span> <span class="kn">import</span> <span class="n">PythonLexer</span>
</span><span class="line">    <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">    <span class="n">lex</span> <span class="o">=</span> <span class="n">PythonLexer</span><span class="p">()</span>
</span><span class="line">    <span class="n">token</span> <span class="o">=</span> <span class="n">lex</span><span class="o">.</span><span class="n">tokens</span>
</span><span class="line">    <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;keywords&#39;</span><span class="p">,</span> <span class="s">&#39;builtins&#39;</span><span class="p">]</span>
</span><span class="line">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
</span><span class="line">        <span class="nb">dict</span><span class="p">[</span><span class="n">i</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">    <span class="nb">dict</span><span class="p">[</span><span class="s">&#39;fu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;.*(def)\W+(.*)\((.*)\)&#39;</span>
</span><span class="line">    <span class="nb">dict</span><span class="p">[</span><span class="s">&#39;cl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;.*(?!&lt;span)(class)(?!=)\W+(?!=)(.*)\((.*)\)&#39;</span>
</span><span class="line">    <span class="nb">dict</span><span class="p">[</span><span class="s">&#39;fm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;.*(from)\W+(.*)\W+(import)\W+(.*)&#39;</span>
</span><span class="line">    <span class="nb">dict</span><span class="p">[</span><span class="s">&#39;im&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;.*(import)\W\{,</span><span class="se">\4</span><span class="s">}(.*)&#39;</span>
</span><span class="line">    <span class="k">return</span> <span class="nb">dict</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">sendMail</span><span class="p">(</span><span class="n">mailserver</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">tolist</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">cc</span><span class="o">=</span><span class="p">[]):</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;发送邮件&#39;&#39;&#39;</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">makeEmail</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">        <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEMultipart</span><span class="p">()</span>
</span><span class="line">        <span class="n">msg</span><span class="p">[</span><span class="s">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span>
</span><span class="line">        <span class="n">msg</span><span class="p">[</span><span class="s">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
</span><span class="line">        <span class="n">msg</span><span class="p">[</span><span class="s">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tolist</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="n">cc</span><span class="p">:</span>
</span><span class="line">            <span class="n">msg</span><span class="p">[</span><span class="s">&#39;Cc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
</span><span class="line">        <span class="n">html_part</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s">&#39;html&#39;</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">html_part</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">msg</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">
</span><span class="line">        <span class="n">smtp</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">()</span>
</span><span class="line">        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Connect to {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mailserver</span><span class="p">))</span>
</span><span class="line">        <span class="n">smtp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mailserver</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span><span class="line">        <span class="n">smtp</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
</span><span class="line">        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Login Success with {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
</span><span class="line">        <span class="n">log</span><span class="p">(</span><span class="s">&#39;To send this Email...&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="n">cc</span><span class="p">:</span>
</span><span class="line">            <span class="n">smtp</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">tolist</span> <span class="o">+</span> <span class="n">cc</span><span class="p">,</span> <span class="n">makeEmail</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="n">smtp</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">tolist</span><span class="p">,</span> <span class="n">makeEmail</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
</span><span class="line">        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Send Success&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">        <span class="n">log</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">paserYaml</span><span class="p">(</span><span class="n">yamlfile</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;解析yaml文件配置&#39;&#39;&#39;</span>
</span><span class="line">    <span class="kn">import</span> <span class="nn">yaml</span>
</span><span class="line">    <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">yamlfile</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;markemail&#39;</span><span class="p">,</span> <span class="p">{})</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">check_email</span><span class="p">(</span><span class="n">emails</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;检查选项是否是邮件格式&#39;&#39;&#39;</span>
</span><span class="line">    <span class="k">print</span> <span class="n">emails</span>
</span><span class="line">    <span class="n">regex</span> <span class="o">=</span> <span class="s">r&#39;&#39;&#39;^[_a-z0-9-]+(\.[a-z0-9-]+)*@[a-z0-9-]+</span>
</span><span class="line"><span class="s">(\.[a-z0-9-]+)*(\.[a-z]{2,3})$&#39;&#39;&#39;</span>
</span><span class="line">    <span class="n">rst</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
</span><span class="line">        <span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span><span class="p">,</span> <span class="n">emails</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
</span><span class="line">    <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">False</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rst</span> <span class="k">else</span> <span class="bp">False</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">colorClass</span><span class="p">():</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;pygments-css对语法的class对应字典&#39;&#39;&#39;</span>
</span><span class="line">    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
</span><span class="line">        <span class="n">cl</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="s">&#39;nc&#39;</span><span class="p">,</span> <span class="s">&#39;nb&#39;</span><span class="p">],</span>
</span><span class="line">        <span class="n">fu</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="s">&#39;nf&#39;</span><span class="p">,</span> <span class="s">&#39;bp&#39;</span><span class="p">],</span>
</span><span class="line">        <span class="n">fm</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;nd&#39;</span><span class="p">,</span> <span class="s">&#39;vi&#39;</span><span class="p">,</span> <span class="s">&#39;nd&#39;</span><span class="p">,</span> <span class="s">&#39;vi&#39;</span><span class="p">],</span>
</span><span class="line">        <span class="n">im</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;nd&#39;</span><span class="p">,</span> <span class="s">&#39;mi&#39;</span><span class="p">],</span>
</span><span class="line">        <span class="n">ke</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;kd&#39;</span><span class="p">],</span>
</span><span class="line">        <span class="n">bu</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;vc&#39;</span><span class="p">]</span>
</span><span class="line">    <span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">cssStyle</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="sd">&#39;&#39;&#39;获取css设置&#39;&#39;&#39;</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">style</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">fusionCss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csshtml</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">        <span class="n">css</span> <span class="o">=</span> <span class="s">&#39;&lt;style type=&quot;text/css&quot;&gt;&#39;</span>
</span><span class="line">        <span class="n">css</span> <span class="o">+=</span> <span class="s">&#39;.codehilite {border: 2px solid rgb(225, 225, 225)}&#39;</span>
</span><span class="line">        <span class="n">css</span> <span class="o">+=</span> <span class="n">csshtml</span>
</span><span class="line">        <span class="n">css</span> <span class="o">+=</span> <span class="s">&#39;&lt;/style&gt;&#39;</span>
</span><span class="line">        <span class="k">return</span> <span class="n">css</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cssdir</span><span class="p">,</span> <span class="n">theme</span><span class="p">):</span>
</span><span class="line">        <span class="sd">&#39;&#39;&#39;从本地css文件&#39;&#39;&#39;</span>
</span><span class="line">        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Fetch css from local dir:{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cssdir</span><span class="p">))</span>
</span><span class="line">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}.css&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cssdir</span><span class="p">,</span> <span class="n">theme</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class="line">            <span class="n">css</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusionCss</span><span class="p">(</span><span class="n">css</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">crawler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theme</span><span class="p">):</span>
</span><span class="line">        <span class="sd">&#39;&#39;&#39;去这个网站爬回来&#39;&#39;&#39;</span>
</span><span class="line">        <span class="kn">import</span> <span class="nn">requests</span>
</span><span class="line">        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Fetch css from site:igniteflow.com&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span class="line">            <span class="s">&#39;http://igniteflow.com/static/css/pygments/{0}.css&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">theme</span><span class="p">))</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusionCss</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">)(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">FabricHtml</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">css</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">css</span> <span class="o">=</span> <span class="n">css</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">md_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeToHtml</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">makeToHtml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Markdown converted into html&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="n">input_file</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="n">text</span> <span class="o">=</span> <span class="n">input_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class="line">        <span class="k">return</span> <span class="n">markdown</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">AddCssToHtml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">css_html</span><span class="p">):</span>
</span><span class="line">        <span class="sd">&#39;&#39;&#39;增加css的style&#39;&#39;&#39;</span>
</span><span class="line">        <span class="n">ohtml</span> <span class="o">=</span> <span class="n">css_html</span>
</span><span class="line">        <span class="n">c</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;```&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="n">inc</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">        <span class="n">ohtml</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">        <span class="k">for</span> <span class="n">inc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span class="line">            <span class="k">if</span> <span class="n">inc</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
</span><span class="line">                <span class="n">ohtml</span> <span class="o">+=</span> <span class="s">&#39;&lt;div class=&quot;codehilite&quot;&gt;&#39;</span>
</span><span class="line">            <span class="k">else</span><span class="p">:</span>
</span><span class="line">                <span class="n">ohtml</span> <span class="o">+=</span> <span class="s">&#39;&lt;/div&gt;&#39;</span>
</span><span class="line">            <span class="n">ohtml</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="n">inc</span><span class="p">]</span>
</span><span class="line">            <span class="n">inc</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line">        <span class="k">return</span> <span class="n">ohtml</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">makeSpan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span class="line">        <span class="sd">&#39;&#39;&#39;构造span包含符合的语法块&#39;&#39;&#39;</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="n">html</span><span class="p">:</span>
</span><span class="line">            <span class="k">return</span> <span class="s">&#39;&#39;</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="s">&#39;&lt;span class=&quot;{0}&quot;&gt;{1}&lt;/span&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">markHtml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span><span class="line">        <span class="sd">&#39;&#39;&#39;给html加python语法的颜色css&#39;&#39;&#39;</span>
</span><span class="line">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">regex</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span class="line">            <span class="n">args</span> <span class="o">=</span> <span class="n">colorClass</span><span class="p">()[</span><span class="n">k</span><span class="p">]</span>
</span><span class="line">            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span><span class="line">                <span class="n">match</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
</span><span class="line">                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
</span><span class="line">                    <span class="n">h</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeSpan</span><span class="p">(</span>
</span><span class="line">                        <span class="n">match</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">h</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">        <span class="n">has_css_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AddCssToHtml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md_html</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">css</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygments</span><span class="p">(</span><span class="n">has_css_html</span><span class="p">)</span> <span class="o">+</span> <span class="n">template</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">pygments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Mark span label with python syntax&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="n">ohtml</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="line">        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">html</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
</span><span class="line">            <span class="n">ohtml</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">markHtml</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span><span class="line">            <span class="n">ohtml</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
</span><span class="line">        <span class="k">return</span> <span class="n">ohtml</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">checkSchema</span><span class="p">(</span><span class="n">schemadict</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;Pythonic的检查schema&#39;&#39;&#39;</span>
</span><span class="line">    <span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span><span class="n">schemadict</span><span class="p">)</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">args</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class="line">    <span class="k">except</span> <span class="n">SchemaError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">        <span class="k">raise</span>
</span><span class="line">        <span class="nb">exit</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</span><span class="line">    <span class="k">return</span> <span class="n">args</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class="line">
</span><span class="line">    <span class="n">args</span> <span class="o">=</span> <span class="n">docopt</span><span class="p">(</span><span class="n">__doc__</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&#39;1.0r1&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">isLocal</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;--local&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">hasConfig</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;--config&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">theme</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;--theme&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">hasConfig</span><span class="p">:</span>
</span><span class="line">        <span class="n">checkSchema</span><span class="p">({</span>
</span><span class="line">            <span class="s">&#39;--config&#39;</span><span class="p">:</span> <span class="n">And</span><span class="p">(</span><span class="n">Use</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
</span><span class="line">                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span>
</span><span class="line">                            <span class="n">error</span><span class="o">=</span><span class="s">&#39;Invalid config format or not exists&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="p">},</span> <span class="p">{</span><span class="s">&#39;--config&#39;</span><span class="p">:</span> <span class="n">hasConfig</span><span class="p">}</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">        <span class="n">yamlConfig</span> <span class="o">=</span> <span class="n">paserYaml</span><span class="p">(</span><span class="n">hasConfig</span><span class="p">)</span>
</span><span class="line">        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">yamlConfig</span><span class="p">)</span>
</span><span class="line">    <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;--config&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="n">isLocal</span><span class="p">:</span>
</span><span class="line">        <span class="n">checkSchema</span><span class="p">({</span>
</span><span class="line">            <span class="s">&#39;--local&#39;</span><span class="p">:</span> <span class="n">And</span><span class="p">(</span><span class="n">Use</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">,</span>
</span><span class="line">                           <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}.css&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span class="line">                                                    <span class="n">n</span><span class="p">,</span> <span class="n">theme</span><span class="p">)),</span> <span class="n">error</span><span class="o">=</span>
</span><span class="line">                           <span class="s">&#39;Invalid custom css dir or hasnot this theme&#39;</span><span class="p">),</span>
</span><span class="line">        <span class="p">},</span> <span class="p">{</span><span class="s">&#39;--local&#39;</span><span class="p">:</span> <span class="n">isLocal</span><span class="p">}</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">        <span class="n">css_dict</span> <span class="o">=</span> <span class="n">cssStyle</span><span class="p">(</span><span class="s">&#39;local&#39;</span><span class="p">,</span> <span class="n">isLocal</span><span class="p">,</span> <span class="n">theme</span><span class="p">)</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="n">css_dict</span> <span class="o">=</span> <span class="n">cssStyle</span><span class="p">(</span><span class="s">&#39;crawler&#39;</span><span class="p">,</span> <span class="n">theme</span><span class="p">)</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</span><span class="line">    <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;--local&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;--theme&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">args</span> <span class="o">=</span> <span class="n">checkSchema</span><span class="p">({</span>
</span><span class="line">        <span class="s">&#39;MDFILE&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;--mailserver&#39;</span><span class="p">:</span> <span class="n">Use</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s">&#39;Invalid server format&#39;</span><span class="p">),</span>
</span><span class="line">        <span class="s">&#39;--mailto&#39;</span><span class="p">:</span> <span class="n">And</span><span class="p">(</span><span class="n">Use</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">check_email</span><span class="p">(</span><span class="n">n</span><span class="p">),</span>
</span><span class="line">                        <span class="n">error</span><span class="o">=</span><span class="s">&#39;Invalid email format&#39;</span><span class="p">),</span>
</span><span class="line">        <span class="s">&#39;--subject&#39;</span><span class="p">:</span> <span class="n">Or</span><span class="p">(</span><span class="n">Use</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="n">Use</span><span class="p">(</span><span class="nb">unicode</span><span class="p">),</span>
</span><span class="line">                        <span class="n">error</span><span class="o">=</span><span class="s">&#39;Invalid suject format&#39;</span><span class="p">),</span>
</span><span class="line">        <span class="s">&#39;--password&#39;</span><span class="p">:</span> <span class="n">Use</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s">&#39;Invalid suject format&#39;</span><span class="p">),</span>
</span><span class="line">        <span class="s">&#39;--cc&#39;</span><span class="p">:</span> <span class="n">Or</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">And</span><span class="p">(</span><span class="n">Use</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">check_email</span><span class="p">(</span><span class="n">n</span><span class="p">)),</span>
</span><span class="line">                   <span class="n">error</span><span class="o">=</span><span class="s">&#39;Invalid email format&#39;</span><span class="p">),</span>
</span><span class="line">        <span class="s">&#39;--output&#39;</span><span class="p">:</span> <span class="n">Or</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
</span><span class="line">        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span class="line">        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">),</span> <span class="n">n</span><span class="p">))),</span>
</span><span class="line">            <span class="n">error</span><span class="o">=</span><span class="s">&#39;Dir must exists&#39;</span><span class="p">),</span>
</span><span class="line">        <span class="s">&#39;--template&#39;</span><span class="p">:</span> <span class="n">Or</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s">&#39;template must exists&#39;</span><span class="p">),</span>
</span><span class="line">        <span class="s">&#39;--username&#39;</span><span class="p">:</span> <span class="n">Use</span><span class="p">(</span><span class="n">check_email</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s">&#39;Invalid username format&#39;</span><span class="p">),</span>
</span><span class="line">        <span class="s">&#39;--help&#39;</span><span class="p">:</span> <span class="n">Or</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">),</span>
</span><span class="line">        <span class="s">&#39;--version&#39;</span><span class="p">:</span> <span class="n">Or</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</span><span class="line">    <span class="p">},</span> <span class="n">args</span><span class="p">)</span>
</span><span class="line">    <span class="n">do</span> <span class="o">=</span> <span class="n">FabricHtml</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;MDFILE&#39;</span><span class="p">],</span> <span class="n">css_dict</span><span class="p">)</span>
</span><span class="line">    <span class="n">cc</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;--cc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;--cc&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;--template&#39;</span><span class="p">]:</span>
</span><span class="line">        <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;--template&#39;</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class="line">            <span class="n">html_content</span> <span class="o">=</span> <span class="n">do</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="n">html_content</span> <span class="o">=</span> <span class="n">do</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</span><span class="line">    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;--output&#39;</span><span class="p">]:</span>
</span><span class="line">        <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;--output&#39;</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class="line">            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span>
</span><span class="line">            <span class="nb">exit</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="n">sendMail</span><span class="p">(</span>
</span><span class="line">        <span class="n">args</span><span class="p">[</span><span class="s">&#39;--mailserver&#39;</span><span class="p">],</span>
</span><span class="line">        <span class="n">args</span><span class="p">[</span><span class="s">&#39;--username&#39;</span><span class="p">],</span>
</span><span class="line">        <span class="n">args</span><span class="p">[</span><span class="s">&#39;--password&#39;</span><span class="p">],</span>
</span><span class="line">        <span class="n">args</span><span class="p">[</span><span class="s">&#39;--mailto&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">),</span>
</span><span class="line">        <span class="n">args</span><span class="p">[</span><span class="s">&#39;--subject&#39;</span><span class="p">],</span>
</span><span class="line">        <span class="n">html_content</span><span class="p">,</span>
</span><span class="line">        <span class="n">cc</span>
</span><span class="line">    <span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class="line">
</span><span class="line">    <span class="n">main</span><span class="p">()</span>
</span></pre></figure></notextile></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/udevsheng-ji-de-wang-qia-zhong-ming-ming-wen-ti-he-jie-jue/">Udev升级的网卡重命名问题和解决</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-27T15:32:00+08:00" pubdate data-updated="true">Apr 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4 id="section">故障描述</h4>

<p>最近终于更新了下gentoo，重启发现我的eth0网卡启动失败：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line"> * Bringing up interface eth0
</span><span class="line"> *   ERROR: interface eth0 does not exist
</span><span class="line"> *   Ensure that you have loaded the correct kernel module for your hardware
</span><span class="line"> * ERROR: net.eth0 failed to start</span></pre></figure></notextile></div>
<p>而启动某些我常用的服务，比如mongodb，也报错：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">~ # /etc/init.d/mongodb restart
</span><span class="line"> * Bringing up interface eth0
</span><span class="line"> *   ERROR: interface eth0 does not exist
</span><span class="line"> *   Ensure that you have loaded the correct kernel module for your hardware
</span><span class="line"> * ERROR: net.eth0 failed to start
</span><span class="line"> * ERROR: cannot start mongodb as net.eth0 would not start</span></pre></figure></notextile></div>

<p>竟然也需要启动网卡？</p>

<h6 id="dmesg">查看内核和dmesg：</h6>

<p>查看内核模块已经选中，而且以前eth0也有，再看dmesg</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">dmesg |grep network 
</span><span class="line">[   74.261872] systemd-udevd[14259]: renamed network interface wlan0 to wlp2s0
</span><span class="line">[   74.391865] systemd-udevd[14259]: renamed network interface eth0 to enp0s4
</span></pre></figure></notextile></div>

<p>原来被重命名了</p>

<h4 id="section-1">为什么？</h4>

<p>从udev-197将自动分配更好的接口名字，具体解释请看[PredictableNetworkInterfaceNames]
(http://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames),</p>

<h4 id="section-2">解决办法，有三种</h4>

<ol>
  <li>临时办法，重启还是会失效</li>
</ol>

<p>ifrename -i enp0s4 -n eth0 #修改网卡名字变成原来的eth0</p>

<ol>
  <li>使用新的名字</li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">rm /etc/init.d/net.eth0 #删除不存在的引用
</span><span class="line">
</span><span class="line">localhost ~ # rc-update delete net.eth0 default #删除不存在的开机启动
</span><span class="line"> * service net.eth0 removed from runlevel default
</span><span class="line">localhost ~ # rc-update add net.enp0s4 default #使用新名字</span></pre></figure></notextile></div>

<ol>
  <li>重置udev的rules，还是用原来的方法</li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">ln -s /dev/null /etc/udev/rules.d/80-net-name-slot.rules</span></pre></figure></notextile></div>

<p>第二种，和第三种需要重启</p>

<h4 id="section-3">启动应用为什么也需要启动应该启动的网卡</h4>

<p>查看/etc/init.d/mongodb脚本，发现是因为depend，一般的初始化脚本结构是</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">#!/sbin/runscript
</span><span class="line">
</span><span class="line">depend() {
</span><span class="line">  （依赖关系信息）
</span><span class="line">}
</span><span class="line">
</span><span class="line">start() {
</span><span class="line">  （启动服务所必需的命令）
</span><span class="line">}
</span><span class="line">
</span><span class="line">stop() {
</span><span class="line">  （停止服务所必需的命令）
</span><span class="line">}
</span><span class="line">
</span><span class="line">restart() {
</span><span class="line">  （重启服务所必需的命令）
</span><span class="line">}</span></pre></figure></notextile></div>
<p>比如 mongodb 的依赖是</p>

<div class="bogus-wrapper"><notextile><figure class="code"><pre class="sh_"><span class="line">depend() {
</span><span class="line">  need net #需要依赖net.X
</span><span class="line">}</span></pre></figure></notextile></div>

<p>下次我专门研究一篇gentoo初始化脚本的文章</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/archives/octopresszi-ding-yi-markdownde-codeyu-fa/">Octopress自定义markdown的code语法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-27T14:17:00+08:00" pubdate data-updated="true">Apr 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4 id="section">前言</h4>

<p>octopress自带的markdown语法高亮代码，最后展示在页面上的效果比较不友好-不能复制粘贴代码，不高亮，还有很丑的行数提示。
我一直使<a href="shjs.sourceforge.net">SHJS</a>,还算比较喜欢，但是以前每次都是编辑markdown文章，在使用</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><pre class="sh_python"><span class="line"><span class="sb">```XX```</span>
</span></pre></figure></notextile></div>

<p>的时候，使用</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><pre class="sh_python"><span class="line"><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;bogus-wrapper&quot;</span><span class="o">&gt;&lt;</span><span class="n">notextile</span><span class="o">&gt;&lt;</span><span class="n">figure</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;code&quot;</span><span class="o">&gt;&lt;</span><span class="n">pre</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;sh_python&quot;</span><span class="o">&gt;</span>
</span><span class="line"><span class="n">XXX</span>
</span><span class="line"><span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;&lt;/</span><span class="n">figure</span><span class="o">&gt;&lt;/</span><span class="n">notextile</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</span></pre></figure></notextile></div>

<p>这样的苦逼方式，最近实在是不了了，自定义octopress的解析过程</p>

<p>其实就是修改plugins/pygments_code.rb</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><pre class="sh_python"><span class="line"><span class="n">require</span> <span class="s">&#39;pygments&#39;</span>
</span><span class="line"><span class="n">require</span> <span class="s">&#39;fileutils&#39;</span>
</span><span class="line"><span class="n">require</span> <span class="s">&#39;digest/md5&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">PYGMENTS_CACHE_DIR</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s">&#39;../../.pygments-cache&#39;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">)</span>
</span><span class="line"><span class="n">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">PYGMENTS_CACHE_DIR</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">module</span> <span class="n">HighlightCode</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">highlight</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
</span><span class="line">    <span class="n">lang</span> <span class="o">=</span> <span class="s">&#39;ruby&#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s">&#39;ru&#39;</span>
</span><span class="line">    <span class="n">lang</span> <span class="o">=</span> <span class="s">&#39;objc&#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s">&#39;m&#39;</span>
</span><span class="line">    <span class="n">lang</span> <span class="o">=</span> <span class="s">&#39;perl&#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s">&#39;pl&#39;</span>
</span><span class="line">    <span class="n">lang</span> <span class="o">=</span> <span class="s">&#39;yaml&#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s">&#39;yml&#39;</span>
</span><span class="line">    <span class="nb">str</span> <span class="o">=</span> <span class="n">pygments</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="o">/&lt;</span><span class="n">pre</span><span class="o">&gt;</span><span class="p">(</span><span class="o">.+</span><span class="p">)</span><span class="o">&lt;</span>\<span class="o">/</span><span class="n">pre</span><span class="o">&gt;/</span><span class="n">m</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="o">/</span> <span class="o">*</span><span class="err">$</span><span class="o">/</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="c">#strip out divs &lt;div class=&quot;highlight&quot;&gt;</span>
</span><span class="line">    <span class="n">tableize_code</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
</span><span class="line">  <span class="n">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">pygments</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">defined</span><span class="err">?</span><span class="p">(</span><span class="n">PYGMENTS_CACHE_DIR</span><span class="p">)</span>
</span><span class="line">      <span class="n">path</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PYGMENTS_CACHE_DIR</span><span class="p">,</span> <span class="s">&quot;#{lang}-#{Digest::MD5.hexdigest(code)}.html&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="k">if</span> <span class="n">File</span><span class="o">.</span><span class="n">exist</span><span class="err">?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class="line">        <span class="n">highlighted_code</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class="line">      <span class="k">else</span>
</span><span class="line">        <span class="n">highlighted_code</span> <span class="o">=</span> <span class="n">Pygments</span><span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">:</span><span class="n">lexer</span> <span class="o">=&gt;</span> <span class="n">lang</span><span class="p">,</span> <span class="p">:</span><span class="n">formatter</span> <span class="o">=&gt;</span> <span class="s">&#39;html&#39;</span><span class="p">,</span> <span class="p">:</span><span class="n">options</span> <span class="o">=&gt;</span> <span class="p">{:</span><span class="n">encoding</span> <span class="o">=&gt;</span> <span class="s">&#39;utf-8&#39;</span><span class="p">})</span>
</span><span class="line">        <span class="n">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="n">highlighted_code</span><span class="p">)</span> <span class="p">}</span>
</span><span class="line">      <span class="n">end</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">highlighted_code</span> <span class="o">=</span> <span class="n">Pygments</span><span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">:</span><span class="n">lexer</span> <span class="o">=&gt;</span> <span class="n">lang</span><span class="p">,</span> <span class="p">:</span><span class="n">formatter</span> <span class="o">=&gt;</span> <span class="s">&#39;html&#39;</span><span class="p">,</span> <span class="p">:</span><span class="n">options</span> <span class="o">=&gt;</span> <span class="p">{:</span><span class="n">encoding</span> <span class="o">=&gt;</span> <span class="s">&#39;utf-8&#39;</span><span class="p">})</span>
</span><span class="line">    <span class="n">end</span>
</span><span class="line">    <span class="n">highlighted_code</span>
</span><span class="line">  <span class="n">end</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">tableize_code</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">lang</span> <span class="o">=</span> <span class="s">&#39;python&#39;</span><span class="p">)</span> <span class="c">#主要是修改这个方法</span>
</span><span class="line">    <span class="n">table</span> <span class="o">=</span> <span class="s">&quot;&lt;pre class=&#39;sh_#{lang}&#39;&gt;&quot;</span>
</span><span class="line">    <span class="nb">str</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">each_with_index</span> <span class="n">do</span> <span class="o">|</span><span class="n">line</span><span class="p">,</span><span class="n">index</span><span class="o">|</span>
</span><span class="line">      <span class="n">table</span> <span class="o">+=</span> <span class="s">&quot;&lt;span class=&#39;line&#39;&gt;#{line}&lt;/span&gt;&quot;</span>
</span><span class="line">    <span class="n">end</span>
</span><span class="line">    <span class="n">table</span> <span class="o">+=</span> <span class="s">&quot;&lt;/pre&gt;&quot;</span>
</span><span class="line">  <span class="n">end</span>
</span><span class="line"><span class="n">end</span>
</span></pre></figure></notextile></div>

<h4 id="section-1">使用方法</h4>

<p>和过去一样，在md的文章中使用:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><pre class="sh_python"><span class="line"><span class="sb">```XX```</span>
</span></pre></figure></notextile></div>

<p>要是想指定某语言，需要先引用这个css，然后在md中
比如这里用bash语法（也是我的默认）</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><pre class="sh_python"><span class="line"><span class="sb">``</span><span class="err">`</span><span class="n">bash</span>
</span><span class="line"><span class="n">XX</span>
</span><span class="line">\<span class="sb">``</span><span class="err">`</span> <span class="c"># 这里不能正常显示，加个反斜杠</span>
</span></pre></figure></notextile></div>
</div>
  
  


    </article>
  
  <ul class="pager">
    
    <li class="previous"><a href="/page/7/">&larr; Older</a></li>
    
    <li><a href="/blog/archives">博客文章</a></li>
    
    <li class="next"><a href="/page/5/">Newer &rarr;</a></li>
    
  </ul>
</div>
<aside class="sidebar-nav span3">
  
    <section class='well'>
    <ul id='qq' class='nav'>
        <li class='nav-header'>我新建了一个QQ群</li>
        <li style="padding-left: 15px;">121435120</li>
        <li style="padding-left: 15px;">欢迎入伙</li>
    </ul>
</section>
<section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">最近发布</li>
    
      <li class="post">
        <a href="/archives/fang-djangobookde-markdownwen-zhang-ping-zhu-xi-tong/">仿Djangobook的Markdown文章评注系统</a>
      </li>
    
      <li class="post">
        <a href="/archives/shi-yong-github-webhookfu-wu-shi-xian-ti-przi-dong-jian-cha-flake8bing-zai-dui-ying-wei-zhi-fa-ping-lun/">使用Github webhook服务实现提PR自动检查Flake8并在对应位置发评论</a>
      </li>
    
      <li class="post">
        <a href="/archives/zui-jin-zai-xie-ben-webkai-fa-zhu-ti-de-shu/">最近在写一本Python Web开发的书</a>
      </li>
    
      <li class="post">
        <a href="/archives/codekai-yuan-liao/">CODE开源了</a>
      </li>
    
      <li class="post">
        <a href="/archives/12ge-pythonnao-jin-ji-zhuan-wan/">12个python填空题</a>
      </li>
    
      <li class="post">
        <a href="/archives/wo-li-jie-de-pythonzui-jia-shi-jian/">我理解的python最佳实践</a>
      </li>
    
      <li class="post">
        <a href="/archives/pythonjin-jie-bi-du-hui-zong/">python进阶必读汇总</a>
      </li>
    
      <li class="post">
        <a href="/archives/liao-liao-pythonmian-shi-zhe-jian-shi-er/">聊聊python面试这件事儿</a>
      </li>
    
      <li class="post">
        <a href="/archives/idiomatic-python/">idiomatic python</a>
      </li>
    
      <li class="post">
        <a href="/archives/r-shang-chuan-wen-jian-fu-wu/">r - 上传文件服务</a>
      </li>
    
  </ul>
</section>
<section class="well">
  <ul id="recent_posts" class="nav nav-list">
  <li class="nav-header">个人网站</li>
    <li class="post"><a href="http://salogs.com">带我入行的boss</a></li>
    <li class="post"><a href="http://dongweiming.github.com/">小明明s Github Blog</a></li>
    <li class="post"><a href="http://youhouer.appspot.com/">Love story(GAE)</a></li>
    <li class="post"><a href="http://www.unixhot.com">unixhot运维社区</a></li>
    <li class="post"><a href="http://www.vpsee.com">Vpsee</a></li>
    <li class="post"><a href="http://dongweiming.github.io/sed_and_awk/">sed_and_awk</a></li>
    <li class="post"><a href="http://dongweiming.github.io/Expert-Python">Expert-Python</a></li>
  </ul>
</section>

<section class="well">
  <ul id="gh_repos" class="nav">
    <li class="nav-header">GitHub帐号</li>
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/dongweiming">@dongweiming</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        github.showRepos({
            user: 'dongweiming',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/asides/github.js" type="text/javascript"> </script>
</section>




<section class="well">
   <ul id="gh_repos" class="nav">
    <li class="nav-header">标签Cloud</li>
  </ul>
  <div id="tag-cloud"></div>
</section>

<section class="well">
  <ul id="gh_repos" class="nav">
    <li class="nav-header">豆瓣阅读</li>
  </ul>
  <script type="text/javascript" src="http://www.douban.com/service/badge/62943420/?select=random&amp;n=10&amp;columns=2&amp;picsize=medium&amp;hidelogo=true&amp;hideself=true&amp;cat=book|music" ></script>
  <a href="https://www.douban.com/people/62943420">@小明明</a> on Douban 
</section>


<section class='well'>
<ul id='gh_repos' class='nav'>
<li class='nav-header'>文章统计</li>
<li>本站共有 271 篇文章</li>
</ul>
</section>


  
</aside>

      </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2016 - Dongweiming -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dongwm';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
